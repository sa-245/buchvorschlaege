<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Buchvorschl&auml;ge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f0e8;
    --card: #ffffff;
    --card-border: rgba(0,0,0,0.08);
    --accent: #3d7a50;
    --accent-soft: rgba(61,122,80,0.12);
    --accent-glow: rgba(61,122,80,0.06);
    --text: #2c2a26;
    --text-soft: #56534c;
    --text-muted: #6e6a62;
    --white: #2c2a26;
    --divider: rgba(0,0,0,0.07);
    --radius: 4px;
    --serif: 'Playfair Display', Georgia, serif;
    --sans: 'Inter', system-ui, -apple-system, sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    font-weight: 300;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* ─── Top Bar ─── */
  .top-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 12px 20px 0;
    max-width: 1280px;
    margin: 0 auto;
    gap: 12px;
  }

  .auth-btn {
    background: var(--accent);
    border: none;
    border-radius: 4px;
    color: #fff;
    font-family: var(--sans);
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    padding: 8px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(61,122,80,0.3);
  }

  .auth-btn:hover { background: #2d6a40; box-shadow: 0 4px 12px rgba(61,122,80,0.4); }

  /* ─── Login Modal ─── */
  .login-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.4); z-index: 1000;
    justify-content: center; align-items: center;
  }
  .login-overlay.active { display: flex; }
  .login-modal {
    background: var(--card); border-radius: 8px; padding: 32px;
    width: 380px; max-width: 90vw; position: relative;
    box-shadow: 0 8px 40px rgba(0,0,0,0.15);
  }
  .login-modal-close {
    position: absolute; top: 12px; right: 16px;
    background: none; border: none; color: var(--text-muted);
    font-size: 1.3rem; cursor: pointer;
  }
  .login-modal-close:hover { color: var(--text); }
  .login-modal-title {
    font-family: var(--serif); font-size: 1.1rem; font-weight: 700;
    color: var(--text); margin-bottom: 20px; text-align: center;
  }
  .login-google-btn {
    width: 100%; padding: 10px; border: 1px solid var(--card-border);
    border-radius: var(--radius); background: var(--card);
    color: var(--text); font-family: var(--sans); font-size: 0.8rem;
    cursor: pointer; display: flex; align-items: center;
    justify-content: center; gap: 8px; transition: border-color 0.2s;
  }
  .login-google-btn:hover { border-color: var(--accent); }
  .login-google-btn svg { width: 18px; height: 18px; }
  .login-divider {
    display: flex; align-items: center; gap: 12px;
    margin: 18px 0; color: var(--text-muted); font-size: 0.7rem;
  }
  .login-divider::before, .login-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--divider);
  }
  .login-tabs {
    display: flex; gap: 0; margin-bottom: 14px; border-bottom: 1px solid var(--divider);
  }
  .login-tab {
    flex: 1; background: none; border: none; border-bottom: 2px solid transparent;
    padding: 8px 0; font-family: var(--sans); font-size: 0.72rem;
    color: var(--text-muted); cursor: pointer; transition: all 0.2s;
  }
  .login-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .login-form-input {
    width: 100%; background: var(--bg); border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text);
    font-family: var(--sans); font-size: 0.8rem; font-weight: 300;
    padding: 10px 12px; outline: none; margin-bottom: 10px;
    transition: border-color 0.2s;
  }
  .login-form-input::placeholder { color: var(--text-muted); }
  .login-form-input:focus { border-color: var(--accent); }
  .login-submit-btn {
    width: 100%; padding: 10px; border: none; border-radius: var(--radius);
    background: var(--accent); color: #fff; font-family: var(--sans);
    font-size: 0.78rem; font-weight: 500; cursor: pointer;
    transition: opacity 0.2s; margin-top: 4px;
  }
  .login-submit-btn:hover { opacity: 0.85; }
  .login-error {
    color: #a3281c; font-size: 0.68rem; margin-bottom: 8px;
    display: none; text-align: center;
  }
  .login-error.active { display: block; }
  .login-toggle {
    text-align: center; margin-top: 12px; font-size: 0.68rem; color: var(--text-muted);
  }
  .login-toggle button {
    background: none; border: none; color: var(--accent);
    font-family: var(--sans); font-size: 0.68rem; cursor: pointer;
    text-decoration: underline;
  }

  .user-info {
    display: none;
    align-items: center;
    gap: 10px;
  }

  .user-info.active { display: flex; }

  .user-avatar {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 1px solid var(--card-border);
    background: var(--card);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.55rem;
    font-weight: 500;
    color: var(--text-soft);
    overflow: hidden;
  }

  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .user-name {
    font-size: 0.78rem;
    color: var(--text-soft);
    font-weight: 400;
  }

  .logout-btn {
    background: none;
    border: 1px solid var(--text-muted);
    border-radius: 2px;
    color: var(--text-muted);
    font-size: 0.65rem;
    cursor: pointer;
    font-family: var(--sans);
    letter-spacing: 0.04em;
    padding: 4px 10px;
    transition: all 0.2s;
  }

  .logout-btn:hover { border-color: var(--text-soft); color: var(--text-soft); }

  /* ─── Hero ─── */
  .hero {
    text-align: center;
    padding: 28px 24px 20px;
    border-bottom: 1px solid var(--divider);
  }

  .hero h1 {
    font-family: var(--serif);
    font-size: 2rem;
    font-weight: 700;
    color: var(--white);
    letter-spacing: 0.02em;
  }

  .hero .tagline {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 6px;
    font-style: italic;
    font-family: var(--serif);
    letter-spacing: 0.04em;
  }

  .pill-row {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 18px;
    flex-wrap: wrap;
  }

  .pill {
    padding: 4px 12px;
    border: 1px solid var(--text-muted);
    border-radius: 2px;
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-soft);
  }

  .pill.accent {
    border-color: var(--accent);
    color: var(--accent);
  }

  .divider-line {
    width: 40px; height: 1px;
    background: var(--accent);
    margin: 20px auto 0;
    opacity: 0.5;
  }

  .meta-info {
    margin-top: 14px;
    display: flex;
    justify-content: center;
    gap: 24px;
    font-size: 0.78rem;
    color: var(--text-muted);
    letter-spacing: 0.02em;
  }

  .meta-info span { display: flex; align-items: center; gap: 6px; }
  .meta-sep { color: var(--text-muted); opacity: 0.3; }

  /* ─── Grid (ausgeloggt) ─── */
  .grid {
    max-width: 1280px;
    margin: 0 auto;
    padding: 28px 20px 48px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    align-items: stretch;
  }

  /* ─── Card ─── */
  .book-card {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    overflow: hidden;
    padding: 24px;
    display: flex;
    flex-direction: column;
    transition: border-color 0.3s ease;
  }

  .book-card:hover { border-color: rgba(139,32,32,0.2); }

  .card-header { display: flex; gap: 16px; }

  .cover-wrap {
    flex-shrink: 0;
    width: 90px; height: 135px;
    border-radius: 2px;
    overflow: hidden;
    background: rgba(0,0,0,0.05);
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }

  .cover-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .cover-placeholder {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(145deg, var(--accent-soft), rgba(61,122,80,0.06));
    color: var(--accent); font-family: var(--serif);
    font-weight: 700; font-size: 1.1rem; letter-spacing: 0.02em;
    text-align: center; padding: 6px;
    line-height: 1.2; word-break: break-word;
  }

  .card-info {
    flex: 1; min-width: 0;
    display: flex; flex-direction: column; justify-content: center;
  }

  .genre-label {
    display: inline-block;
    padding: 2px 0;
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    width: fit-content;
  }

  .book-title {
    font-family: var(--serif);
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1.3;
    margin-top: 4px;
    color: var(--white);
  }

  .author-line { display: flex; align-items: center; gap: 8px; margin-top: 8px; }

  .author-avatar {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 1px solid var(--card-border);
    background: rgba(0,0,0,0.05);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.48rem; font-weight: 500; color: var(--text-soft); flex-shrink: 0;
  }

  .author-name { font-size: 0.88rem; color: var(--text-soft); font-weight: 400; }

  .rating-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }

  .star-display { color: var(--text-muted); font-size: 0.7rem; letter-spacing: 1px; }
  .star-display .lit { color: var(--white); }
  .rating-num { font-size: 0.85rem; font-weight: 500; color: var(--white); }
  .year-tag { font-size: 0.75rem; color: var(--text-muted); margin-left: auto; }

  .lang-tag {
    display: inline-block;
    margin-top: 6px; padding: 2px 0;
    font-size: 0.65rem; font-weight: 400;
    letter-spacing: 0.04em; color: var(--text-muted);
  }

  .card-divider { border: none; border-top: 1px solid var(--divider); margin: 18px 0; }

  .section-label {
    font-size: 0.65rem; font-weight: 500;
    text-transform: uppercase; letter-spacing: 0.12em;
    color: var(--text-muted); margin-bottom: 8px;
  }

  .book-summary {
    font-size: 0.92rem; line-height: 1.75;
    color: var(--text); font-weight: 300; flex: 1;
  }

  .reason-box {
    margin-top: auto;
    padding: 14px 16px;
    background: var(--accent-soft);
    border-left: 2px solid var(--accent);
    border-radius: 0 var(--radius) var(--radius) 0;
  }

  .reason-box .section-label { color: var(--accent); margin-bottom: 5px; }

  .reason-text { font-size: 0.88rem; line-height: 1.65; color: var(--text); font-weight: 300; }

  /* ─── Tracking Buttons ─── */
  .track-row {
    display: flex;
    gap: 1px;
    margin-top: 14px;
    border-radius: var(--radius);
    overflow: hidden;
  }

  .track-btn {
    flex: 1;
    background: rgba(0,0,0,0.02);
    border: none;
    color: var(--text-muted);
    font-family: var(--sans);
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    padding: 8px 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .track-btn:hover { background: rgba(0,0,0,0.04); color: var(--text-soft); }

  .track-btn.active {
    background: var(--accent-soft);
    color: var(--accent);
  }

  .track-btn .track-icon { display: block; font-size: 0.85rem; margin-bottom: 2px; }

  .track-btn.needs-login { opacity: 0.45; cursor: pointer; }
  .track-btn.needs-login:hover { opacity: 0.65; background: rgba(0,0,0,0.03); }

  /* ─── Login-Hinweis Toast ─── */
  .login-toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--card); color: var(--text);
    font-family: var(--sans); font-size: 0.78rem; font-weight: 400;
    padding: 14px 22px; border-radius: 10px;
    box-shadow: 0 6px 28px rgba(0,0,0,0.12), 0 0 0 1px var(--card-border);
    display: flex; align-items: center; gap: 12px;
    z-index: 2000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  .login-toast.visible { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
  .login-toast-text { line-height: 1.3; }
  .login-toast-btn {
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    font-family: var(--sans); font-size: 0.72rem; font-weight: 500;
    padding: 7px 16px; cursor: pointer; white-space: nowrap;
    transition: background 0.2s;
  }
  .login-toast-btn:hover { background: #2d6a40; }

  /* ─── History ─── */
  .history { max-width: 1280px; margin: 0 auto; padding: 0 20px 12px; }
  .history details { border-top: 1px solid var(--divider); }
  .history summary {
    display: flex; align-items: center; gap: 8px; padding: 16px 0;
    cursor: pointer; font-size: 0.72rem; font-weight: 500;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted); list-style: none; transition: color 0.2s ease;
  }
  .history summary:hover { color: var(--text-soft); }
  .history summary::-webkit-details-marker { display: none; }
  .history summary::marker { content: ''; }
  .history summary .arrow { display: inline-block; transition: transform 0.2s ease; font-size: 0.6rem; }
  .history details[open] summary .arrow { transform: rotate(90deg); }
  .history-list { padding-bottom: 20px; }
  .history-day { padding: 14px 0; border-top: 1px solid var(--divider); }
  .history-day:first-child { border-top: none; }
  .history-date {
    font-size: 0.68rem; font-weight: 500; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px;
  }
  .history-books { display: flex; gap: 20px; flex-wrap: wrap; }
  .history-item { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px; }
  .history-cover {
    width: 36px; height: 54px; border-radius: 2px; overflow: hidden;
    background: rgba(0,0,0,0.05); flex-shrink: 0; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .history-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .history-meta { min-width: 0; }
  .history-title { font-family: var(--serif); font-size: 0.82rem; font-weight: 700; color: var(--text); line-height: 1.3; }
  .history-author { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
  .history-rating { font-size: 0.65rem; color: var(--text-muted); margin-top: 1px; }
  .history-rating .lit { color: var(--text-soft); }

  /* ─── Footer ─── */
  .footer {
    text-align: center; padding: 10px 16px 36px;
    font-size: 0.75rem; color: var(--text-muted);
    font-family: var(--serif); font-style: italic; letter-spacing: 0.04em;
  }

  /* ══════════════════════════════════════════════════ */
  /* ─── DASHBOARD (Logged-in Mode) ─── */
  /* ══════════════════════════════════════════════════ */

  .dashboard { display: none; }

  body.logged-in #mainContent { display: none; }
  body.logged-in #loginBtn { display: none; }

  body.logged-in {
    --bg: #f2f0ea;
  }

  body.logged-in .dashboard { display: block; }

  body.logged-in .top-bar {
    border-bottom: 2px solid var(--accent);
    padding-bottom: 12px;
    margin-bottom: 0;
  }

  .dash-layout {
    max-width: 1280px;
    margin: 0 auto;
    padding: 24px 20px;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 28px;
    min-height: calc(100vh - 60px);
  }

  /* ─── Sidebar ─── */
  .sidebar {
    border-right: 1px solid var(--divider);
    padding-right: 24px;
  }

  .sidebar-title {
    font-size: 0.65rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--divider);
  }

  .sidebar-card {
    display: flex;
    gap: 10px;
    padding: 12px 0;
    border-bottom: 1px solid var(--divider);
    transition: opacity 0.2s;
  }

  .sidebar-card:hover { opacity: 0.85; }

  .sidebar-cover {
    width: 50px; height: 75px;
    border-radius: 2px;
    overflow: hidden;
    background: rgba(0,0,0,0.05);
    flex-shrink: 0;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  }

  .sidebar-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .sidebar-clickable { cursor: pointer; transition: opacity 0.2s; }
  .sidebar-clickable:hover { opacity: 0.65; }

  .sidebar-detail-link {
    display: block; text-align: center;
    font-size: 0.65rem; color: var(--accent); padding: 12px 0 4px;
    cursor: pointer; transition: opacity 0.2s;
    border-top: 1px solid var(--divider);
    margin-top: 4px;
  }
  .sidebar-detail-link:hover { opacity: 0.7; }

  .sidebar-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }

  .sidebar-book-title {
    font-family: var(--serif);
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--white);
    line-height: 1.3;
  }

  .sidebar-author {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .sidebar-rating {
    font-size: 0.62rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .sidebar-rating .lit { color: var(--text-soft); }

  .sidebar-track-row {
    display: flex;
    gap: 1px;
    margin-top: 6px;
    border-radius: 2px;
    overflow: hidden;
  }

  .sidebar-track-btn {
    flex: 1;
    background: rgba(0,0,0,0.02);
    border: none;
    color: var(--text-muted);
    font-family: var(--sans);
    font-size: 0.55rem;
    font-weight: 500;
    padding: 4px 2px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .sidebar-track-btn:hover { background: rgba(0,0,0,0.04); color: var(--text-soft); }
  .sidebar-track-btn.active { background: var(--accent-soft); color: var(--accent); }

  /* ─── Main Content ─── */
  .main-content { min-width: 0; }

  .dash-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
  }

  .dash-title {
    font-family: var(--serif);
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
  }

  .show-suggestions-btn {
    margin-left: auto;
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    color: var(--text-soft);
    font-family: var(--sans);
    font-size: 0.7rem;
    font-weight: 400;
    padding: 8px 14px;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    white-space: nowrap;
  }
  .show-suggestions-btn:hover { border-color: var(--accent); color: var(--accent); }

  .suggestions-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.4); z-index: 1000;
    overflow-y: auto; padding: 40px 20px;
  }
  .suggestions-overlay.active { display: block; }
  .suggestions-overlay-inner {
    max-width: 960px; margin: 0 auto;
    background: var(--bg); border-radius: 8px;
    padding: 32px; position: relative;
    box-shadow: 0 8px 40px rgba(0,0,0,0.15);
  }
  .suggestions-overlay-close {
    position: absolute; top: 16px; right: 20px;
    background: none; border: none; color: var(--text-muted);
    font-size: 1.4rem; cursor: pointer; line-height: 1;
  }
  .suggestions-overlay-close:hover { color: var(--text); }
  .suggestions-overlay-title {
    font-family: var(--serif); font-size: 1.3rem; font-weight: 700;
    color: var(--text); margin-bottom: 24px;
  }
  .suggestions-overlay-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
  }
  @media (max-width: 700px) {
    .suggestions-overlay-grid { grid-template-columns: 1fr; }
  }

  /* ─── Book Detail Overlay ─── */
  .book-detail-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.4); z-index: 1000;
    justify-content: center; align-items: center;
    padding: 20px;
  }
  .book-detail-overlay.active { display: flex; }
  .book-detail-inner {
    background: var(--card); border-radius: 8px;
    padding: 28px 32px; max-width: 520px; width: 100%;
    position: relative; box-shadow: 0 8px 40px rgba(0,0,0,0.15);
    max-height: 80vh; overflow-y: auto;
  }
  .book-detail-close {
    position: absolute; top: 12px; right: 16px;
    background: none; border: none; color: var(--text-muted);
    font-size: 1.3rem; cursor: pointer;
  }
  .book-detail-close:hover { color: var(--text); }
  .book-detail-header {
    display: flex; gap: 18px; margin-bottom: 16px;
  }
  .book-detail-cover {
    width: 80px; height: 120px; border-radius: 3px; overflow: hidden;
    background: rgba(0,0,0,0.05); flex-shrink: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
  }
  .book-detail-cover img { width: 100%; height: 100%; object-fit: cover; }
  .book-detail-title {
    font-family: var(--serif); font-size: 1.05rem; font-weight: 700;
    color: var(--text); line-height: 1.3;
  }
  .book-detail-author {
    font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;
  }
  .book-detail-desc {
    font-size: 0.78rem; color: var(--text-soft); line-height: 1.6;
  }
  .book-detail-loading {
    font-size: 0.75rem; color: var(--text-muted); font-style: italic;
  }
  .book-detail-none {
    font-size: 0.75rem; color: var(--text-muted); font-style: italic;
  }

  /* ─── Search in Dashboard ─── */
  .dash-search {
    margin-bottom: 28px;
  }

  .dash-search-row {
    display: flex; gap: 8px;
  }

  .dash-search-input {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 300;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .dash-search-input::placeholder { color: var(--text-muted); }
  .dash-search-input:focus { border-color: var(--accent); }

  .dash-search-btn {
    background: var(--accent);
    border: none;
    border-radius: var(--radius);
    color: #fff;
    font-family: var(--sans);
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    padding: 10px 18px;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
  }

  .dash-search-btn:hover { opacity: 0.85; }
  .dash-search-btn:disabled { opacity: 0.4; cursor: default; }

  .dash-manual-btn {
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    color: var(--text-soft);
    white-space: nowrap;
    font-family: var(--sans);
    font-size: 0.72rem;
    font-weight: 400;
    padding: 10px 14px;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    white-space: nowrap;
  }
  .dash-manual-btn:hover { border-color: var(--accent); color: var(--accent); }

  .manual-form {
    display: none; margin-top: 12px;
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: var(--radius); padding: 16px;
  }
  .manual-form.active { display: block; }
  .manual-form-title {
    font-size: 0.75rem; font-weight: 500; color: var(--text);
    margin-bottom: 12px; letter-spacing: 0.04em;
  }
  .manual-form-row {
    display: flex; gap: 8px; margin-bottom: 8px;
  }
  .manual-form-input {
    flex: 1;
    background: var(--bg); border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text);
    font-family: var(--sans); font-size: 0.8rem; font-weight: 300;
    padding: 8px 12px; outline: none;
    transition: border-color 0.2s;
  }
  .manual-form-input::placeholder { color: var(--text-muted); }
  .manual-form-input:focus { border-color: var(--accent); }
  .manual-form-actions {
    display: flex; gap: 8px; align-items: center; margin-top: 4px;
  }
  .manual-form-actions select {
    background: var(--bg); border: 1px solid var(--card-border);
    color: var(--text-soft); font-family: var(--sans);
    font-size: 0.72rem; padding: 8px 10px; border-radius: var(--radius);
    cursor: pointer;
  }
  .manual-save-btn {
    background: var(--accent); border: none; border-radius: var(--radius);
    color: #fff; font-family: var(--sans); font-size: 0.72rem;
    font-weight: 500; letter-spacing: 0.06em;
    padding: 8px 18px; cursor: pointer; transition: opacity 0.2s;
  }
  .manual-save-btn:hover { opacity: 0.85; }
  .manual-cancel-btn {
    background: none; border: none; color: var(--text-muted);
    font-family: var(--sans); font-size: 0.72rem; cursor: pointer;
  }
  .manual-cancel-btn:hover { color: var(--text); }

  .dash-search-results {
    margin-top: 12px;
    display: none;
  }

  .dash-search-results.active { display: block; }

  .search-results-label {
    font-size: 0.62rem; font-weight: 500;
    text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--text-muted); margin-bottom: 8px;
  }

  .search-result-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--divider);
  }

  .search-result-cover {
    width: 40px; height: 60px; border-radius: 2px;
    overflow: hidden; background: rgba(0,0,0,0.05); flex-shrink: 0;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .search-result-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .search-result-info { flex: 1; min-width: 0; }

  .search-result-title {
    font-family: var(--serif); font-size: 0.82rem;
    font-weight: 700; color: var(--text); line-height: 1.3;
  }

  .search-result-author { font-size: 0.68rem; color: var(--text-muted); margin-top: 2px; }
  .search-result-year { font-size: 0.62rem; color: var(--text-muted); margin-top: 1px; }
  .search-result-genres { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px; }
  .search-genre-pill { font-size: 0.52rem; padding: 1px 7px; border-radius: 8px; background: var(--accent-soft); color: var(--accent); letter-spacing: 0.01em; }

  .search-result-actions { display: flex; gap: 4px; flex-shrink: 0; align-self: center; }

  .search-add-btn {
    background: none;
    border: 1px solid var(--text-muted);
    border-radius: 2px;
    color: var(--text-soft);
    font-family: var(--sans);
    font-size: 0.6rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .search-add-btn:hover { border-color: var(--accent); color: var(--accent); }

  .search-add-btn.added {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--accent);
    cursor: default;
  }

  .search-no-results {
    color: var(--text-muted); font-size: 0.8rem;
    font-style: italic; padding: 12px 0;
    font-family: var(--serif);
  }

  .search-close {
    background: var(--accent-soft); border: 1px solid var(--accent-glow);
    color: var(--accent); cursor: pointer;
    font-size: 0.65rem; font-family: var(--sans);
    letter-spacing: 0.04em; padding: 6px 16px;
    border-radius: 14px; transition: all 0.2s;
    display: inline-block; margin: 6px 0;
  }

  .search-close:hover { background: var(--accent); color: var(--card); }

  .search-manual-hint {
    text-align: center; padding: 12px 0; font-size: 0.72rem; color: var(--text-muted);
  }
  .search-manual-hint button {
    background: none; border: none; color: var(--accent);
    font-family: var(--sans); font-size: 0.72rem; cursor: pointer;
    text-decoration: underline; padding: 0;
  }
  .search-manual-hint button:hover { opacity: 0.7; }

  /* ─── Book Category Sections ─── */
  .book-category {
    margin-bottom: 28px;
  }

  .category-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--divider);
    margin-bottom: 12px;
  }

  .category-icon {
    font-size: 0.9rem;
  }

  h2.category-title, .category-title {
    font-size: 0.72rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-soft);
    margin: 0;
  }

  .category-count {
    font-size: 0.65rem;
    color: var(--text-muted);
    font-weight: 400;
  }

  .filter-row {
    display: flex; gap: 6px; align-items: center;
    margin-left: auto;
  }
  .filter-btn {
    background: none; border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text-muted);
    font-family: var(--sans); font-size: 0.6rem;
    padding: 5px 10px; cursor: pointer; min-height: 26px;
    transition: color 0.2s, border-color 0.2s;
  }
  .filter-btn:hover { color: var(--accent); border-color: var(--accent); }
  .filter-btn.active { color: var(--accent); border-color: var(--accent); font-weight: 500; }
  .filter-year-select {
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text-muted);
    font-family: var(--sans); font-size: 0.6rem;
    padding: 3px 6px; cursor: pointer;
  }
  .filter-year-select.active { color: var(--accent); border-color: var(--accent); }

  .category-books { }

  .cat-book-item {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 14px 0;
    border-bottom: 1px solid var(--divider);
    transition: background 0.2s;
  }

  .cat-book-item:hover { background: rgba(0,0,0,0.015); }

  .cat-book-header {
    display: flex;
    align-items: flex-start;
    gap: 14px;
  }

  .cat-book-cover {
    width: 50px; height: 75px; border-radius: 3px;
    overflow: hidden; background: rgba(0,0,0,0.05); flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .cat-book-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }

  .cat-book-info { flex: 1; min-width: 0; }

  .cat-book-title-row {
    display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap;
  }

  .cat-book-title {
    font-family: var(--serif); font-size: 0.88rem;
    font-weight: 700; color: var(--white); line-height: 1.3;
  }

  .cat-book-author { font-size: 0.72rem; color: var(--text-muted); margin-top: 3px; }

  .cat-book-meta {
    display: flex; align-items: center; gap: 10px; margin-top: 6px; flex-wrap: wrap;
  }

  .cat-book-hearts {
    display: flex; gap: 2px;
  }
  .cat-book-hearts span {
    font-size: 0.72rem; color: var(--text-muted); opacity: 0.4;
  }
  .cat-book-hearts span.filled { color: #c94040; opacity: 1; }

  .cat-book-details {
    padding-left: 64px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .cat-book-cards-row {
    display: flex; gap: 10px; flex-wrap: wrap;
  }

  .cat-book-card-box {
    flex: 1; min-width: 160px;
    font-size: 0.7rem; color: var(--text-soft);
    line-height: 1.5;
    background: var(--accent-glow); border-radius: var(--radius);
    padding: 10px 12px;
  }
  .cat-book-card-label {
    font-size: 0.55rem; font-weight: 500; color: var(--accent);
    text-transform: uppercase; letter-spacing: 0.05em;
    margin-bottom: 4px;
  }
  .cat-book-card-text {
    font-style: italic;
  }
  .cat-book-card-quote {
    font-style: italic; margin-top: 4px;
    padding-left: 8px; border-left: 2px solid var(--accent-soft);
  }
  .cat-book-card-quote + .cat-book-card-quote { margin-top: 6px; }

  .edit-hearts-row {
    display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
  }
  .edit-hearts-label {
    font-size: 0.65rem; color: var(--text-muted);
  }
  .edit-heart-btn {
    background: none; border: none; font-size: 1rem; cursor: pointer;
    color: var(--text-muted); opacity: 0.4; transition: opacity 0.15s, color 0.15s;
    min-width: 28px; min-height: 28px;
    padding: 0 1px;
  }
  .edit-heart-btn.filled { color: #c94040; opacity: 1; }
  .edit-heart-btn:hover { opacity: 0.7; }

  .edit-fazit-input {
    width: 100%;
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text);
    font-family: var(--sans); font-size: 0.75rem; font-weight: 300;
    padding: 8px 10px; outline: none; resize: vertical; min-height: 60px;
    transition: border-color 0.2s;
  }
  .edit-fazit-input::placeholder { color: var(--text-muted); }
  .edit-fazit-input:focus { border-color: var(--accent); }

  .cat-book-recommended {
    font-size: 0.65rem; color: var(--accent); font-weight: 400;
  }

  .cat-book-genres {
    display: inline-flex; gap: 4px; flex-wrap: wrap; vertical-align: baseline;
  }
  .genre-pill {
    font-size: 0.55rem; color: var(--accent); background: var(--accent-soft);
    padding: 1px 8px; border-radius: 10px; white-space: nowrap;
    font-family: var(--sans); font-weight: 400; line-height: 1.6;
  }


  .cat-book-location {
    font-size: 0.62rem; color: var(--text-muted); display: flex; align-items: center; gap: 4px;
  }
  .cat-book-location-icon { font-size: 0.7rem; }

  .edit-location-row {
    display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; align-items: center;
  }
  .edit-location-chip {
    font-size: 0.6rem; padding: 4px 10px; border-radius: 12px;
    border: 1px solid var(--card-border); background: var(--card);
    color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; min-height: 26px;
    display: inline-flex; align-items: center;
  }
  .edit-location-chip.selected { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }
  .edit-location-chip.selected::before { content: '\2713 '; font-size: 0.55rem; margin-right: 2px; }
  .edit-location-custom {
    flex: 1; min-width: 100px; max-width: 180px;
    font-size: 0.62rem; padding: 3px 8px; border-radius: 12px;
    border: 1px solid var(--card-border); background: var(--card);
    color: var(--text); font-family: var(--sans); outline: none;
    transition: border-color 0.2s;
  }
  .edit-location-custom::placeholder { color: var(--text-muted); }
  .edit-location-custom:focus { border-color: var(--accent); }

  .edit-format-row {
    display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px; align-items: center;
  }
  .edit-format-label {
    font-size: 0.6rem; color: var(--text-muted); margin-right: 2px;
  }
  .edit-format-chip {
    font-size: 0.6rem; padding: 4px 12px; border-radius: 12px;
    border: 1px solid var(--card-border); background: var(--card);
    color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; min-height: 26px;
    display: inline-flex; align-items: center; gap: 4px;
  }
  .edit-format-chip.selected { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }
  .edit-format-chip .format-icon { font-size: 0.7rem; }

  .cat-book-format {
    font-size: 0.62rem; color: var(--text-muted);
    display: inline-flex; align-items: center; gap: 3px;
    background: var(--accent-glow); padding: 1px 8px; border-radius: 10px;
  }
  .cat-book-format-icon { font-size: 0.65rem; }

  .edit-genre-row {
    display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px;
  }
  .edit-genre-chip {
    font-size: 0.6rem; padding: 4px 10px; border-radius: 12px;
    border: 1px solid var(--card-border); background: var(--card);
    color: var(--text-muted); cursor: pointer;
    transition: all 0.15s; min-height: 26px;
    display: inline-flex; align-items: center;
  }
  .edit-genre-chip.selected { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }
  .edit-genre-chip.selected::before { content: '\2713 '; font-size: 0.55rem; margin-right: 2px; }

  .edit-quotes-area {
    width: 100%;
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text);
    font-family: var(--sans); font-size: 0.7rem; font-weight: 300;
    font-style: italic; padding: 8px 10px; outline: none;
    resize: vertical; min-height: 50px;
    transition: border-color 0.2s;
  }
  .edit-quotes-area::placeholder { color: var(--text-muted); font-style: italic; }
  .edit-quotes-area:focus { border-color: var(--accent); }

  /* ─── Statistics ─── */
  .stats-section {
    margin-bottom: 28px; padding: 22px 24px;
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: var(--radius);
  }
  h2.stats-title, .stats-title {
    font-family: var(--serif); font-size: 0.9rem; font-weight: 700;
    color: var(--text); margin: 0 0 18px 0;
  }
  .stats-grid {
    display: grid; grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }
  @media (max-width: 700px) {
    .stats-grid { grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 400px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }
  .stat-card {
    text-align: center; padding: 16px 8px;
    background: var(--bg); border-radius: var(--radius);
  }
  .stat-number {
    font-family: var(--serif); font-size: 1.5rem; font-weight: 700;
    color: var(--accent); line-height: 1;
  }
  .stat-label {
    font-size: 0.6rem; color: var(--text-muted); margin-top: 6px; line-height: 1.3;
  }
  .stats-genres {
    margin-top: 16px; display: flex; gap: 6px; flex-wrap: wrap;
  }
  .stats-genre-pill {
    font-size: 0.6rem; padding: 3px 10px; border-radius: 12px;
    background: var(--accent-soft); color: var(--accent);
  }

  .cat-book-links {
    display: flex; gap: 12px;
  }
  .cat-book-links a {
    font-size: 0.65rem; color: var(--accent); text-decoration: none;
    border-bottom: 1px dotted var(--accent); transition: opacity 0.2s;
  }
  .cat-book-links a:hover { opacity: 0.7; }

  .cat-book-footer {
    display: flex; align-items: center; justify-content: flex-end;
    gap: 10px; padding-left: 64px; margin-top: 4px;
  }

  .cat-book-date {
    font-size: 0.62rem; color: var(--text-muted); white-space: nowrap;
  }
  .cat-book-actions-wrap { flex-shrink: 0; }

  .edit-btn {
    background: none; border: 1px solid var(--card-border); color: var(--text-muted);
    cursor: pointer; font-size: 0.62rem; padding: 4px 10px;
    border-radius: var(--radius); display: inline-flex;
    align-items: center; gap: 4px; font-family: var(--sans);
    transition: all 0.2s;
  }
  .edit-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }

  .edit-form {
    display: none; width: 100%; padding: 12px 0 4px 0;
  }
  .edit-form.active { display: block; }
  .edit-form-row {
    display: flex; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;
  }
  .edit-form-input {
    flex: 1; min-width: 120px;
    background: var(--card); border: 1px solid var(--card-border);
    border-radius: var(--radius); color: var(--text);
    font-family: var(--sans); font-size: 0.75rem; font-weight: 300;
    padding: 6px 10px; outline: none;
    transition: border-color 0.2s;
  }
  .edit-form-input::placeholder { color: var(--text-muted); }
  .edit-form-input:focus { border-color: var(--accent); }
  .edit-form-input.full { flex: 1 1 100%; }
  .edit-form-input.readonly {
    opacity: 0.4; cursor: default; background: var(--bg);
    border-color: transparent; font-size: 0.62rem; color: var(--text-muted);
  }
  .edit-form-input.readonly:focus { border-color: transparent; }
  .edit-cover-row { display: flex; gap: 8px; align-items: center; }
  .edit-cover-row .edit-form-input { flex: 1; }
  .edit-cover-upload-btn {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--card); border: 1px solid var(--accent);
    border-radius: var(--radius); color: var(--accent);
    font-family: var(--sans); font-size: 0.65rem; font-weight: 500;
    padding: 6px 12px; cursor: pointer; white-space: nowrap;
    transition: background 0.2s, color 0.2s;
  }
  .edit-cover-upload-btn:hover { background: var(--accent); color: #fff; }
  .edit-form-actions { display: flex; gap: 8px; margin-top: 4px; }
  .edit-save-btn {
    background: var(--accent); border: none; border-radius: var(--radius);
    color: #fff; font-family: var(--sans); font-size: 0.65rem;
    font-weight: 500; padding: 5px 14px; cursor: pointer;
    transition: opacity 0.2s;
  }
  .edit-save-btn:hover { opacity: 0.85; }
  .edit-cancel-btn {
    background: none; border: none; color: var(--text-muted);
    font-family: var(--sans); font-size: 0.65rem; cursor: pointer;
  }
  .edit-cancel-btn:hover { color: var(--text); }

  .status-select {
    background: var(--card); border: 1px solid var(--card-border);
    color: var(--text-soft); font-family: var(--sans);
    font-size: 0.68rem; padding: 4px 8px; border-radius: 2px;
    cursor: pointer;
  }

  .remove-btn {
    background: none; border: none;
    color: var(--text-muted); cursor: pointer;
    font-size: 0.85rem; padding: 2px 4px;
    transition: color 0.2s;
  }

  .remove-btn:hover { color: var(--accent); }

  .read-date-row {
    display: flex; align-items: center; gap: 6px; margin-top: 4px;
  }
  .read-date-row label {
    font-size: 0.65rem; color: var(--text-muted); white-space: nowrap;
  }
  .read-date-select {
    background: var(--card); border: 1px solid var(--card-border);
    color: var(--text-soft); font-family: var(--sans);
    font-size: 0.65rem; padding: 2px 4px; border-radius: 2px;
    cursor: pointer;
  }

  .category-empty {
    color: var(--text-muted); font-size: 0.78rem;
    font-style: italic; padding: 14px 0;
    font-family: var(--serif);
  }

  /* ─── Responsive ─── */
  @media (max-width: 900px) {
    .grid { grid-template-columns: repeat(2, 1fr); max-width: 680px; }
    .grid .book-card:last-child { grid-column: 1 / -1; max-width: 50%; justify-self: center; }
    .dash-layout { grid-template-columns: 1fr; }
    .sidebar { border-right: none; padding-right: 0; border-bottom: 1px solid var(--divider); padding-bottom: 20px; margin-bottom: 4px; }
    .sidebar-card { display: inline-flex; width: auto; margin-right: 12px; }
  }
  @media (max-width: 540px) {
    .grid { grid-template-columns: 1fr; max-width: 440px; gap: 16px; }
    .grid .book-card:last-child { grid-column: auto; max-width: 100%; }
    .hero h1 { font-size: 1.6rem; }
    .meta-info { flex-direction: column; gap: 4px; align-items: center; }
    .pill-row { gap: 4px; }
    .pill { font-size: 0.62rem; padding: 3px 8px; }
    .dash-layout { padding: 16px 12px; }
  }

  /* ─── Barrierefreiheit / WCAG 2.2 ─── */

  /* Sichtbare Fokus-Indikatoren */
  *:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, [tabindex="0"]:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Visually hidden – f&uuml;r Screenreader sichtbar, visuell versteckt */
  .sr-only {
    position: absolute; width: 1px; height: 1px;
    padding: 0; margin: -1px; overflow: hidden;
    clip: rect(0,0,0,0); white-space: nowrap; border: 0;
  }

  /* Skip-Link */
  .skip-link {
    position: absolute; top: -100%; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: #fff; padding: 10px 24px;
    font-family: var(--sans); font-size: 0.85rem; font-weight: 500;
    border-radius: 0 0 var(--radius) var(--radius);
    z-index: 9999; text-decoration: none;
    transition: top 0.2s;
  }
  .skip-link:focus { top: 0; }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
</head>
<body>

<a href="#mainContent" class="skip-link">Zum Inhalt springen</a>

<!-- Top Bar -->
<header class="top-bar" role="banner">
  <nav aria-label="Benutzernavigation">
    <button id="loginBtn" class="auth-btn" onclick="handleLogin()">Meine B&uuml;cher-Liste</button>
    <div id="userInfo" class="user-info">
      <div id="userAvatar" class="user-avatar" aria-hidden="true"></div>
      <span id="userName" class="user-name"></span>
      <button class="logout-btn" onclick="handleLogout()">Abmelden</button>
    </div>
  </nav>
</header>

<!-- ═══ AUSGELOGGTE ANSICHT ═══ -->

<main id="mainContent" role="main">

<section class="hero" aria-label="Tages&uuml;bersicht">
  <h1>Deine Buchvorschl&auml;ge</h1>
  <p class="tagline">Drei handverlesene Empfehlungen</p>
  <div class="pill-row">
    <span class="pill">Thriller</span>
    <span class="pill">Psychothriller</span>
    <span class="pill">Nordic Noir</span>
    <span class="pill">Mystery</span>
    <span class="pill">Sci-Fi</span>
    <span class="pill accent">4.0+</span>
  </div>
  <div class="divider-line"></div>
  <div class="meta-info" id="metaInfo"></div>
</section>

<section class="grid" id="dailyGrid" aria-label="Buchvorschl&auml;ge"></section>

<!-- Archiv -->
<section class="history" aria-label="Archiv der Buchvorschl&auml;ge">
  <details>
    <summary><span class="arrow">&#9654;</span> Archiv</summary>
    <div class="history-list" id="archiveList"></div>
  </details>
</section>

<footer class="footer" role="contentinfo">Nur B&uuml;cher mit 4.0+ auf Goodreads</footer>

</main>

<!-- ═══ EINGELOGGTE ANSICHT (Dashboard) ═══ -->

<main class="dashboard" role="main" aria-label="Meine B&uuml;cher">
  <div class="dash-layout">
    <aside class="sidebar" aria-label="Heutige Vorschl&auml;ge">
      <h2 class="sidebar-title">Heutige Vorschl&auml;ge</h2>
      <div id="sidebarBooks"></div>
    </aside>
    <section class="main-content" aria-label="B&uuml;cherverwaltung">
      <div class="dash-header">
        <h1 class="dash-title">Meine B&uuml;cher</h1>
      </div>
      <div class="dash-search">
        <div class="dash-search-row">
          <label for="dashSearchInput" class="sr-only">Buch suchen</label>
          <input type="text" id="dashSearchInput" class="dash-search-input" placeholder="Buch suchen &mdash; Titel oder Autor eingeben&hellip;" onkeydown="if(event.key==='Enter')searchBooks()">
          <button class="dash-search-btn" onclick="searchBooks()" id="dashSearchBtn">Suchen</button>
          <button class="dash-manual-btn" onclick="toggleManualForm()" aria-expanded="false" aria-controls="manualForm">+ Manuell</button>
        </div>
        <div id="dashSearchResults" class="dash-search-results" role="region" aria-live="polite" aria-label="Suchergebnisse"></div>
        <div id="manualForm" class="manual-form" role="region" aria-label="Buch manuell hinzuf&uuml;gen">
          <div class="manual-form-title">Buch manuell hinzuf&uuml;gen</div>
          <div class="manual-form-row">
            <label for="manualTitle" class="sr-only">Buchtitel</label>
            <input type="text" id="manualTitle" class="manual-form-input" placeholder="Titel">
            <label for="manualAuthor" class="sr-only">Autor</label>
            <input type="text" id="manualAuthor" class="manual-form-input" placeholder="Autor">
          </div>
          <div class="manual-form-actions">
            <label for="manualStatus" class="sr-only">Lesestatus</label>
            <select id="manualStatus">
              <option value="merkliste">M&ouml;chte ich lesen</option>
              <option value="lese-ich">Lese ich aktuell</option>
              <option value="gelesen">Habe ich gelesen</option>
            </select>
            <button class="manual-save-btn" onclick="saveManualBook()">Hinzuf&uuml;gen</button>
            <button class="manual-cancel-btn" onclick="toggleManualForm()">Abbrechen</button>
          </div>
        </div>
      </div>
      <div id="dashCategories"></div>
    </section>
  </div>
</main>

<!-- Book Detail Overlay -->
<div id="bookDetailOverlay" class="book-detail-overlay" role="dialog" aria-modal="true" aria-label="Buchdetails" onclick="if(event.target===this)closeBookDetail()">
  <div class="book-detail-inner">
    <button class="book-detail-close" onclick="closeBookDetail()" aria-label="Schlie&szlig;en">&times;</button>
    <div id="bookDetailContent"></div>
  </div>
</div>

<!-- Login Modal -->
<div id="loginOverlay" class="login-overlay" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle" onclick="if(event.target===this)closeLoginModal()">
  <div class="login-modal">
    <button class="login-modal-close" onclick="closeLoginModal()" aria-label="Schlie&szlig;en">&times;</button>
    <h2 class="login-modal-title" id="loginModalTitle">Meine B&uuml;cher-Liste</h2>
    <button class="login-google-btn" onclick="handleGoogleLogin()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Mit Google anmelden
    </button>
    <div class="login-divider" aria-hidden="true">oder</div>
    <div id="loginError" class="login-error" role="alert" aria-live="assertive"></div>
    <div id="emailLoginMode" data-mode="login">
      <label for="loginEmail" class="sr-only">E-Mail-Adresse</label>
      <input type="email" id="loginEmail" class="login-form-input" placeholder="E-Mail-Adresse" autocomplete="email">
      <label for="loginPassword" class="sr-only">Passwort</label>
      <input type="password" id="loginPassword" class="login-form-input" placeholder="Passwort (mind. 6 Zeichen)" autocomplete="current-password" onkeydown="if(event.key==='Enter')handleEmailAuth()">
      <button class="login-submit-btn" id="emailSubmitBtn" onclick="handleEmailAuth()">Anmelden</button>
      <div class="login-toggle">
        <span id="toggleText">Noch kein Konto?</span>
        <button onclick="toggleEmailMode()"><span id="toggleBtnText">Registrieren</span></button>
      </div>
    </div>
  </div>
</div>

<!-- Suggestions Overlay -->
<div id="suggestionsOverlay" class="suggestions-overlay" role="dialog" aria-modal="true" aria-labelledby="suggestionsTitle" onclick="if(event.target===this)closeSuggestionsOverlay()">
  <div class="suggestions-overlay-inner">
    <button class="suggestions-overlay-close" onclick="closeSuggestionsOverlay()" aria-label="Schlie&szlig;en">&times;</button>
    <h2 class="suggestions-overlay-title" id="suggestionsTitle">Buchvorschl&auml;ge des Tages</h2>
    <div class="suggestions-overlay-grid" id="suggestionsOverlayGrid"></div>
  </div>
</div>

<!-- Screenreader-Feedback f&uuml;r Aktionen -->
<div id="srAnnounce" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<!-- Login-Hinweis Toast -->
<div class="login-toast" id="loginToast" role="alert" aria-live="polite">
  <span class="login-toast-text">Melde dich an, um B&uuml;cher zu speichern</span>
  <button class="login-toast-btn" onclick="handleLogin()">Anmelden</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyAEUW1N1ZDyHWI8tvduoiUISc8TpJ34pHk",
    authDomain: "buchvorschlaege.firebaseapp.com",
    projectId: "buchvorschlaege",
    storageBucket: "buchvorschlaege.firebasestorage.app",
    messagingSenderId: "586584496249",
    appId: "1:586584496249:web:889a0cb7274b1e796bdca8"
  };

  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.firestore();
  var currentUser = null;

  // ─── Redirect-Ergebnis abfangen ───
  auth.getRedirectResult().then(function(result) {
    if (result.user) console.log('Login via Redirect erfolgreich:', result.user.displayName);
  }).catch(function(error) {
    console.error('Redirect-Login Fehler:', error.code, error.message);
    alert('Login-Fehler: ' + error.message);
  });

  // ─── Tägliche Vorschläge rendern ───
  renderDailyBooks();
  renderArchive();

  // ─── Auth State ───
  auth.onAuthStateChanged(function(user) {
    currentUser = user;
    var loginBtn = document.getElementById('loginBtn');
    var userInfo = document.getElementById('userInfo');
    var avatar = document.getElementById('userAvatar');
    var userName = document.getElementById('userName');
    var trackBtns = document.querySelectorAll('.track-btn');

    if (user) {
      document.body.classList.add('logged-in');
      loginBtn.style.display = 'none';
      userInfo.classList.add('active');

      if (user.photoURL) {
        avatar.innerHTML = '<img src="' + user.photoURL + '" alt="">';
      } else {
        var initials = (user.displayName || user.email || '?').substring(0,2).toUpperCase();
        avatar.textContent = initials;
      }
      userName.textContent = user.displayName || user.email || '';

      trackBtns.forEach(function(btn) { btn.classList.remove('needs-login'); });
      buildSidebar();
      loadUserBooks();
    } else {
      document.body.classList.remove('logged-in');
      loginBtn.style.display = '';
      userInfo.classList.remove('active');
      trackBtns.forEach(function(btn) { btn.classList.add('needs-login'); btn.classList.remove('active'); });
    }
  });

  function handleLogin() {
    document.getElementById('loginOverlay').classList.add('active');
  }

  function closeLoginModal() {
    document.getElementById('loginOverlay').classList.remove('active');
    document.getElementById('loginError').classList.remove('active');
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
  }

  function handleGoogleLogin() {
    var provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(function(result) {
      closeLoginModal();
    }).catch(function(error) {
      if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
        auth.signInWithRedirect(provider);
      } else {
        showLoginError(error.message);
      }
    });
  }

  function handleEmailAuth() {
    var email = document.getElementById('loginEmail').value.trim();
    var password = document.getElementById('loginPassword').value;
    var mode = document.getElementById('emailLoginMode').getAttribute('data-mode');

    if (!email || !password) {
      showLoginError('Bitte E-Mail und Passwort eingeben.');
      return;
    }
    if (password.length < 6) {
      showLoginError('Das Passwort muss mindestens 6 Zeichen lang sein.');
      return;
    }

    document.getElementById('emailSubmitBtn').disabled = true;
    document.getElementById('emailSubmitBtn').textContent = '...';

    var authPromise;
    if (mode === 'register') {
      authPromise = auth.createUserWithEmailAndPassword(email, password);
    } else {
      authPromise = auth.signInWithEmailAndPassword(email, password);
    }

    authPromise.then(function() {
      document.getElementById('emailSubmitBtn').disabled = false;
      document.getElementById('emailSubmitBtn').textContent = mode === 'register' ? 'Registrieren' : 'Anmelden';
      closeLoginModal();
    }).catch(function(error) {
      document.getElementById('emailSubmitBtn').disabled = false;
      document.getElementById('emailSubmitBtn').textContent = mode === 'register' ? 'Registrieren' : 'Anmelden';
      var msg = error.message;
      if (error.code === 'auth/email-already-in-use') msg = 'Diese E-Mail ist bereits registriert.';
      if (error.code === 'auth/invalid-email') msg = 'Ung\u00FCltige E-Mail-Adresse.';
      if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') msg = 'Falsches Passwort.';
      if (error.code === 'auth/user-not-found') msg = 'Kein Konto mit dieser E-Mail gefunden.';
      if (error.code === 'auth/weak-password') msg = 'Das Passwort ist zu schwach (mind. 6 Zeichen).';
      showLoginError(msg);
    });
  }

  function toggleEmailMode() {
    var container = document.getElementById('emailLoginMode');
    var mode = container.getAttribute('data-mode');
    var newMode = mode === 'login' ? 'register' : 'login';
    container.setAttribute('data-mode', newMode);
    document.getElementById('emailSubmitBtn').textContent = newMode === 'register' ? 'Registrieren' : 'Anmelden';
    document.getElementById('toggleText').textContent = newMode === 'register' ? 'Schon ein Konto?' : 'Noch kein Konto?';
    document.getElementById('toggleBtnText').textContent = newMode === 'register' ? 'Anmelden' : 'Registrieren';
    document.getElementById('loginError').classList.remove('active');
  }

  function showLoginError(msg) {
    var el = document.getElementById('loginError');
    el.textContent = msg;
    el.classList.add('active');
  }

  function handleLogout() {
    auth.signOut();
  }

  // ─── Bücher-Pool für tägliche Rotation ───
  var bookPool = [
    {id:'der-insasse',title:'Der Insasse',author:'Sebastian Fitzek',genre:'Psychothriller',rating:4.2,year:2018,cover:'https://books.google.com/books/content?id=NPRYDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Till Berkhoff ist am Boden zerstört: Sein kleiner Sohn Max wurde entführt und ermordet. Der einzige Verdächtige wurde in eine psychiatrische Klinik eingewiesen — und schweigt. Till lässt sich selbst als Patient einweisen, um ein Geständnis zu erzwingen.',reason:'Fitzek auf dem Höhepunkt seines Könnens — ein atemloser Psychothriller mit einem Finale, das man so nicht kommen sieht.'},
    {id:'blutmond',title:'Blutmond',author:'Jo Nesbø',genre:'Nordic Noir / Krimi',rating:4.2,year:2022,cover:'https://books.google.com/books/content?id=KgR7EAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'Harry Hole hat alle Brücken hinter sich abgebrochen. In Oslo werden zwei junge Frauen ermordet. Als ein tatverdächtiger Immobilienmakler Hole ein Vermögen für private Ermittlungen bietet, stellt er ein ungewöhnliches Team zusammen.',reason:'Der 13. Band der legendären Harry-Hole-Reihe. Nordic Noir auf allerhöchstem Niveau.'},
    {id:'der-schwarm',title:'Der Schwarm',author:'Frank Schätzing',genre:'Science Fiction / Thriller',rating:4.1,year:2004,cover:'https://books.google.com/books/content?id=WM5mAgAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'KiWi',summary:'Weltweit häufen sich rätselhafte Ereignisse im Meer. Ein internationales Team von Wissenschaftlern erkennt: Die Ozeane führen Krieg gegen die Menschheit — gesteuert von einer uralten Intelligenz aus der Tiefsee.',reason:'4,5 Millionen verkaufte Exemplare, übersetzt in 27 Sprachen. Ein monumentaler Öko-Thriller.'},
    {id:'die-weisse-kraehe',title:'Die weiße Krähe',author:'Michael Robotham',genre:'Psychothriller',rating:4.4,year:2022,cover:'https://books.google.com/books/content?id=6tAREQAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Goldmann',summary:'Cyrus Haven wird zur Absturzstelle eines Kleinflugzeugs gerufen. An Bord findet man die Leiche einer seit Jahren vermissten Frau. Die Spur führt in die dunkelsten Ecken einer verschlossenen Gemeinschaft.',reason:'Robotham liefert einen fesselnden Thriller mit unvergesslichen Figuren und einer Auflösung, die sprachlos macht.'},
    {id:'der-plan',title:'Der Plan',author:'Julie Clark',genre:'Thriller',rating:4.1,year:2020,cover:'https://books.google.com/books/content?id=HPVFEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Zwei Frauen tauschen am Flughafen ihre Identitäten — jede hat ihre eigenen verzweifelten Gründe. Als eines der Flugzeuge abstürzt, beginnt ein gefährliches Spiel aus Lügen und Geheimnissen.',reason:'Ein cleverer, temporeicher Thriller über zwei Frauen, deren Leben sich auf unerwartete Weise verflechten.'},
    {id:'die-kinder-der-zeit',title:'Die Kinder der Zeit',author:'Adrian Tchaikovsky',genre:'Science Fiction',rating:4.3,year:2015,cover:'https://books.google.com/books/content?id=us2sDgAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Die Menschheit terraformt einen Planeten und impft ihn mit einem Nanovirus, der Affen zu intelligenten Wesen machen soll. Doch nicht die Affen entwickeln sich weiter, sondern Spinnen — zu einer faszinierenden Zivilisation.',reason:'Preisgekrönt mit dem Arthur C. Clarke Award. Ein bahnbrechendes Gedankenexperiment über Evolution und Intelligenz.'},
    {id:'das-ritual',title:'Das Ritual',author:'Adam Nevill',genre:'Horror / Thriller',rating:4.0,year:2011,cover:'https://books.google.com/books/content?id=BDHKAQAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Vier alte Studienfreunde wandern durch die endlosen Wälder Nordschwedens. Als einer sich verletzt, nehmen sie eine Abkürzung — direkt in einen uralten, dunklen Albtraum.',reason:'Ein verstörendes Survival-Horror-Meisterwerk. Verfilmt auf Netflix und von Stephen King gelobt.'},
    {id:'die-therapie',title:'Die Therapie',author:'Sebastian Fitzek',genre:'Psychothriller',rating:4.0,year:2006,cover:'https://books.google.com/books/content?id=rkUqvgAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Psychiater Viktor Larenz zieht sich auf eine einsame Insel zurück, nachdem seine Tochter spurlos verschwand. Dann taucht eine Patientin auf, die behauptet, in ihren Wahnvorstellungen Viktors Tochter zu sehen.',reason:'Fitzeks Debütroman, der sofort zum Bestseller wurde. Der Beginn einer Ära deutscher Psychothriller.'},
    {id:'projekt-9',title:'Projekt 9',author:'Andy Weir',genre:'Science Fiction',rating:4.5,year:2021,cover:'https://books.google.com/books/content?id=FGIZEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Ryland Grace erwacht allein auf einem Raumschiff. Er kann sich an nichts erinnern. Stück für Stück begreift er: Er ist die letzte Hoffnung der Menschheit — und sein einziger Verbündeter ist kein Mensch.',reason:'Vom Autor von „Der Marsianer". Ein Meisterwerk über Freundschaft, Wissenschaft und das Überleben.'},
    {id:'schnee',title:'Schnee',author:'Jo Nesbø',genre:'Nordic Noir / Krimi',rating:4.1,year:2011,cover:'https://books.google.com/books/content?id=QxN-DwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'In Oslo verschwinden Frauen spurlos — immer wenn der erste Schnee fällt. Harry Hole ermittelt gegen einen Serienkiller, der seine Opfer mit einem grausamen Ritual markiert: einem Schneemann.',reason:'Einer der bekanntesten Fälle von Harry Hole. Eiskalte Spannung aus dem hohen Norden.'},
    {id:'die-frau-im-nebel',title:'Die Frau im Nebel',author:'Park Chan-wook',genre:'Mystery / Thriller',rating:4.2,year:2022,cover:'https://books.google.com/books/content?id=aOVhEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Aufbau',summary:'Ein Polizist untersucht den Tod eines Bergsteigers. Die mysteriöse Witwe des Opfers zieht ihn immer tiefer in ihren Bann — zwischen Verdacht, Obsession und einem Geheimnis, das alles verändert.',reason:'Ein neo-noir Meisterwerk, das Hitchcock-Elemente mit modernem Mystery verbindet.'},
    {id:'das-kind',title:'Das Kind',author:'Sebastian Fitzek',genre:'Psychothriller',rating:4.0,year:2008,cover:'https://books.google.com/books/content?id=wqJRPgAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Der zehnjährige Simon behauptet, sich an ein früheres Leben erinnern zu können — als Mörder. Anwalt Robert Stern soll dem Jungen helfen, doch die Erinnerungen führen zu echten Leichen.',reason:'Fitzeks verstörendster Roman. Spielt meisterhaft mit der Frage: Was, wenn ein Kind die Wahrheit sagt?'},
    {id:'der-fanger',title:'Der Fänger',author:'Minette Walters',genre:'Krimi / Mystery',rating:4.1,year:2001,cover:'https://books.google.com/books/content?id=SROLEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Goldmann',summary:'In einer englischen Küstenstadt wird eine Frau brutal ermordet. Die Ermittlungen decken ein Netz aus alten Lügen und Geheimnissen auf, das die ganze Gemeinde durchzieht.',reason:'Walters ist die Grande Dame des britischen Krimis. Psychologisch dicht und unberechenbar.'},
    {id:'dark-matter',title:'Dark Matter',author:'Blake Crouch',genre:'Science Fiction / Thriller',rating:4.2,year:2016,cover:'https://books.google.com/books/content?id=TkLrCgAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Goldmann',summary:'Physikprofessor Jason Dessen wird entführt und wacht in einer Welt auf, die seiner gleicht — aber in der er einen anderen Lebensweg eingeschlagen hat. Um zurückzukehren, muss er die Grenzen der Realität sprengen.',reason:'Ein atemloser Sci-Fi-Thriller über die Viele-Welten-Theorie. Unverfilmbar? Apple TV+ hat es trotzdem geschafft.'},
    {id:'die-letzte-flucht',title:'Die letzte Flucht',author:'Andreas Gruber',genre:'Thriller',rating:4.3,year:2023,cover:'https://books.google.com/books/content?id=6G2lEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Goldmann',summary:'Maarten S. Sneijder und Sabine Nemez ermitteln in einem Fall, der sie an ihre Grenzen bringt. Ein Serienmörder inszeniert seine Taten wie Kunstwerke — und das BKA-Team wird selbst zur Zielscheibe.',reason:'Gruber gehört zur Spitze der deutschsprachigen Thriller-Autoren. Fesselnd bis zur letzten Seite.'},
    {id:'der-gesang-der-flusskrebse',title:'Der Gesang der Flusskrebse',author:'Delia Owens',genre:'Mystery / Krimi',rating:4.5,year:2018,cover:'https://books.google.com/books/content?id=mJBjDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Hanserblau',summary:'Kya Clark wächst allein in den Sümpfen von North Carolina auf. Als ein junger Mann tot aufgefunden wird, fällt der Verdacht auf sie — das „Marschmädchen", das niemand kennt und alle fürchten.',reason:'Über 15 Millionen Exemplare verkauft. Eine unvergessliche Mischung aus Naturpoesie, Coming-of-Age und Kriminalfall.'},
    {id:'der-astronaut',title:'Der Astronaut',author:'Andy Weir',genre:'Science Fiction',rating:4.5,year:2021,cover:'https://books.google.com/books/content?id=FGIZEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Ryland Grace erwacht mutterseelenallein in einem Raumschiff Lichtjahre von der Erde entfernt. Er hat eine Mission, an die er sich nicht erinnert — und einen Begleiter, der alles verändert.',reason:'„Der Marsianer" trifft „Arrival". Andy Weirs bislang bestes Werk, voller Herz und harter Wissenschaft.'},
    {id:'rebecca',title:'Rebecca',author:'Daphne du Maurier',genre:'Mystery / Klassiker',rating:4.2,year:1938,cover:'https://books.google.com/books/content?id=RuPkDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Insel',summary:'Eine junge Frau heiratet den reichen Witwer Maxim de Winter und zieht in sein Anwesen Manderley. Doch der Schatten seiner ersten Frau Rebecca liegt über allem — besonders über der unheimlichen Haushälterin Mrs. Danvers.',reason:'Einer der größten Spannungsromane aller Zeiten. Hitchcock verfilmte ihn, aber das Original ist unerreicht.'},
    {id:'die-verratenen',title:'Die Verratenen',author:'Ursula Poznanski',genre:'Science Fiction / Thriller',rating:4.1,year:2012,cover:'https://books.google.com/books/content?id=GHB1wwEACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Loewe',summary:'In einer Zukunft, in der Bildung das höchste Gut ist, leben Elias und seine Freunde in einer Akademie. Als sie ein Geheimnis entdecken, wird ihre Welt auf den Kopf gestellt — und die Flucht beginnt.',reason:'Poznanski kombiniert Dystopie mit einem Thriller-Plot, der keine Atempause lässt.'},
    {id:'die-hungerspiele',title:'Die Tribute von Panem',author:'Suzanne Collins',genre:'Science Fiction',rating:4.3,year:2008,cover:'https://books.google.com/books/content?id=bGZ-CgAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Oetinger',summary:'In einer dystopischen Zukunft muss jeder Distrikt jährlich zwei Jugendliche in eine tödliche Arena schicken. Katniss Everdeen meldet sich freiwillig — und löst damit eine Revolution aus.',reason:'Das Werk, das eine ganze Generation von Dystopie-Romanen inspiriert hat. Spannend, politisch, unvergesslich.'},
    {id:'gone-girl',title:'Gone Girl',author:'Gillian Flynn',genre:'Psychothriller',rating:4.1,year:2012,cover:'https://books.google.com/books/content?id=jF9SG5_VH7kC&printsec=frontcover&img=1&zoom=1',publisher:'Fischer',summary:'An ihrem fünften Hochzeitstag verschwindet Amy Dunne spurlos. Ihr Mann Nick gerät unter Verdacht. Doch je mehr die Polizei ermittelt, desto mehr Lügen kommen ans Licht — auf beiden Seiten.',reason:'Der Thriller, der das Genre neu definiert hat. Flynns Twists sind mittlerweile legendär.'},
    {id:'das-labyrinth',title:'Das Labyrinth der Lichter',author:'Carlos Ruiz Zafón',genre:'Mystery / Historisch',rating:4.4,year:2016,cover:'https://books.google.com/books/content?id=qekyDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'S. Fischer',summary:'Barcelona, 1959: Alicia Gris ermittelt im Verschwinden eines Ministers. Die Spur führt zum „Friedhof der Vergessenen Bücher" — und zu einem Geheimnis, das seit dem Bürgerkrieg unter der Stadt schlummert.',reason:'Der krönende Abschluss der Friedhof-der-Vergessenen-Bücher-Tetralogie. Zafóns Vermächtnis.'},
    {id:'1984',title:'1984',author:'George Orwell',genre:'Science Fiction / Klassiker',rating:4.2,year:1949,cover:'https://books.google.com/books/content?id=yxv1LK5gyV4C&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'Winston Smith lebt in Ozeanien unter der totalen Überwachung des Großen Bruders. Als er beginnt, das System zu hinterfragen und eine verbotene Liebesbeziehung eingeht, setzt er alles aufs Spiel.',reason:'Der Klassiker der dystopischen Literatur. Aktueller denn je — und erschreckend prophetisch.'},
    {id:'still-alice',title:'Ich bin Alice',author:'Lisa Genova',genre:'Psychothriller / Mystery',rating:4.1,year:2007,cover:'https://books.google.com/books/content?id=OsMpAwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Bastei Lübbe',summary:'Alice Howland, 50, Harvard-Professorin, bemerkt erste Gedächtnislücken. Die Diagnose: früh einsetzende Alzheimer-Krankheit. Was folgt, ist ein erschütternder Kampf gegen das Vergessen.',reason:'Ein zutiefst bewegender Roman, der Alzheimer von innen zeigt. Verfilmt mit Julianne Moore.'},
    {id:'wer-hat-angst',title:'Wer hat Angst',author:'Ursula Poznanski',genre:'Thriller',rating:4.0,year:2023,cover:'https://books.google.com/books/content?id=rTWtEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Wunderlich',summary:'Auf einer idyllischen Insel findet eine exklusive Veranstaltung statt. Doch als die Teilnehmer erkennen, welches Spiel wirklich gespielt wird, gibt es kein Entkommen mehr.',reason:'Poznanski beweist, dass sie auch als Erwachsenen-Thriller-Autorin brilliert. Temporeich und unberechenbar.'},
    {id:'der-marsianer',title:'Der Marsianer',author:'Andy Weir',genre:'Science Fiction',rating:4.4,year:2011,cover:'https://books.google.com/books/content?id=MTPeDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Astronaut Mark Watney wird nach einem Sandsturm auf dem Mars zurückgelassen — alle halten ihn für tot. Mit Einfallsreichtum, Humor und Botanik kämpft er ums Überleben.',reason:'Das Buch, das Hard-Sci-Fi wieder cool gemacht hat. Verfilmt mit Matt Damon — aber das Buch ist besser.'},
    {id:'das-schweigen-der-laemmer',title:'Das Schweigen der Lämmer',author:'Thomas Harris',genre:'Psychothriller / Krimi',rating:4.2,year:1988,cover:'https://books.google.com/books/content?id=mYV-DwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'FBI-Agentin Clarice Starling sucht den Rat des inhaftierten Kannibalen Dr. Hannibal Lecter, um einen anderen Serienmörder zu fassen. Ein Katz-und-Maus-Spiel auf höchstem Niveau.',reason:'Der Roman, der Hannibal Lecter zur Ikone machte. Einer der einflussreichsten Thriller aller Zeiten.'},
    {id:'die-welle',title:'Die Welle',author:'Morton Rhue',genre:'Thriller / Klassiker',rating:4.0,year:1981,cover:'https://books.google.com/books/content?id=2zqVPQAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ravensburger',summary:'Ein Lehrer startet ein Experiment über Faschismus in seiner Klasse. „Die Welle" entwickelt ein erschreckendes Eigenleben — Gehorsam, Uniformität und Ausgrenzung breiten sich wie ein Virus aus.',reason:'Basiert auf einem wahren Experiment. Pflichtlektüre, die zeigt, wie schnell eine Gesellschaft kippen kann.'},
    {id:'die-stadt-der-traeumenden-buecher',title:'Die Stadt der Träumenden Bücher',author:'Walter Moers',genre:'Fantasy / Mystery',rating:4.5,year:2004,cover:'https://books.google.com/books/content?id=XiPeDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Knaus',summary:'Hildegunst von Mythenmetz erbt ein perfektes Manuskript und reist nach Buchhaim, der Stadt der Bücher. Dort gerät er in die Katakomben — ein labyrinthisches Reich voller Gefahren und literarischer Wunder.',reason:'Walter Moers\' Liebeserklärung an die Literatur. Eines der fantasievollsten deutschen Bücher überhaupt.'},
    {id:'das-parfum',title:'Das Parfum',author:'Patrick Süskind',genre:'Historisch / Thriller',rating:4.2,year:1985,cover:'https://books.google.com/books/content?id=qcVgAAAAMAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Diogenes',summary:'Jean-Baptiste Grenouille, geboren im stinkenden Paris des 18. Jahrhunderts, hat die feinste Nase der Welt. Besessen vom perfekten Duft, schreckt er vor nichts zurück — auch nicht vor Mord.',reason:'20 Millionen Exemplare weltweit. Ein einzigartiger, verstörender Roman über Obsession und Geruch.'},
    {id:'der-nachtzirkus',title:'Der Nachtzirkus',author:'Erin Morgenstern',genre:'Fantasy / Mystery',rating:4.0,year:2011,cover:'https://books.google.com/books/content?id=3l0zygAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'Zwei junge Magier werden in einen Wettstreit verwickelt, der in einem mysteriösen Nachtzirkus ausgetragen wird. Doch je mehr sie sich ineinander verlieben, desto tödlicher wird das Spiel.',reason:'Ein atmosphärisches Wunder. Man schmeckt den Karamellduft beim Lesen.'},
    {id:'wir-kinder-vom-bahnhof-zoo',title:'Wir Kinder vom Bahnhof Zoo',author:'Christiane F.',genre:'Sachbuch / Klassiker',rating:4.1,year:1978,cover:'https://books.google.com/books/content?id=BKyxDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Carlsen',summary:'Die erschütternde wahre Geschichte der 13-jährigen Christiane, die in der West-Berliner Drogenszene untergeht. Vom Discobesuch zum Heroin — in weniger als zwei Jahren.',reason:'Ein Zeitdokument, das bis heute aufwühlt. Millionenfach gelesen und nie vergessen.'},
    {id:'die-wahrheit-ueber-den-fall-harry-quebert',title:'Die Wahrheit über den Fall Harry Quebert',author:'Joël Dicker',genre:'Mystery / Krimi',rating:4.2,year:2012,cover:'https://books.google.com/books/content?id=AK3VoAEACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Piper',summary:'Bestsellerautor Marcus Goldman besucht seinen Mentor Harry Quebert — und erfährt, dass im Garten eine seit 33 Jahren vermisste Teenagerin begraben liegt. Marcus beginnt, den wahren Mörder zu suchen.',reason:'Ein raffinierter Krimi im Krimi. Dicker jongliert Zeitebenen und Überraschungen mit Bravour.'},
    {id:'der-hundertjaehrige',title:'Der Hundertjährige, der aus dem Fenster stieg',author:'Jonas Jonasson',genre:'Humor / Historisch',rating:4.0,year:2009,cover:'https://books.google.com/books/content?id=D4OC9QL7eTYC&printsec=frontcover&img=1&zoom=1',publisher:'C. Bertelsmann',summary:'Allan Karlsson klettert an seinem 100. Geburtstag aus dem Fenster des Altersheims und beginnt eine unglaubliche Reise — rückblickend erfahren wir, dass er schon immer ein bewegtes Leben führte.',reason:'Herrlich absurd und historisch lehrreich zugleich. Humor trifft Weltgeschichte.'},
    {id:'shutter-island',title:'Shutter Island',author:'Dennis Lehane',genre:'Psychothriller',rating:4.1,year:2003,cover:'https://books.google.com/books/content?id=sFdpPwAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'US-Marshal Teddy Daniels ermittelt auf einer Gefängnisinsel für psychisch kranke Straftäter. Eine Patientin ist spurlos verschwunden. Je tiefer Teddy gräbt, desto mehr verschwimmt die Grenze zwischen Realität und Wahn.',reason:'Lehane konstruiert ein perfektes Puzzle. Verfilmt von Scorsese — aber das Buch ist noch vielschichtiger.'},
    {id:'die-fliegerin',title:'Die Fliegerin',author:'Tara Westover',genre:'Biografie / Sachbuch',rating:4.5,year:2018,cover:'https://books.google.com/books/content?id=0_VJDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Kiepenheuer & Witsch',summary:'Tara wächst in den Bergen Idahos auf — ohne Schule, ohne Arzt, unter einem paranoiden Vater. Mit 17 betritt sie erstmals einen Klassenraum. Sie schafft es bis nach Cambridge.',reason:'Eine der bewegendsten Biografien unserer Zeit. Ein Buch über die Macht der Bildung.'},
    {id:'the-girl-on-the-train',title:'Girl on the Train',author:'Paula Hawkins',genre:'Psychothriller',rating:4.0,year:2015,cover:'https://books.google.com/books/content?id=Udv-AwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Blanvalet',summary:'Rachel fährt jeden Tag mit dem Zug an ihrem alten Haus vorbei und beobachtet ein scheinbar perfektes Paar. Bis die Frau verschwindet — und Rachel sich nicht erinnern kann, was in der Nacht geschah.',reason:'Der Thriller, der „Gone Girl"-Fans begeistert hat. Ein Meisterwerk über unzuverlässige Erinnerung.'},
    {id:'erebos',title:'Erebos',author:'Ursula Poznanski',genre:'Thriller / Science Fiction',rating:4.2,year:2010,cover:'https://books.google.com/books/content?id=rQJcPwAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Loewe',summary:'An Nicks Schule kursiert ein geheimnisvolles Computerspiel: Erebos. Es kennt seinen Spieler. Es belohnt und bestraft. Und es stellt Aufgaben in der realen Welt — die immer gefährlicher werden.',reason:'Poznanski hat das Genre des Techno-Thrillers für ein junges Publikum revolutioniert. Preisgekrönt und packend.'},
    {id:'der-name-des-windes',title:'Der Name des Windes',author:'Patrick Rothfuss',genre:'Fantasy',rating:4.5,year:2007,cover:'https://books.google.com/books/content?id=VGn3zwEACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Klett-Cotta',summary:'Kvothe, einst ein legendärer Held, erzählt in einer Dorfschenke seine wahre Geschichte: von einer Kindheit bei fahrenden Künstlern, einer magischen Universität und der Jagd nach den Chandrian.',reason:'Einer der am besten geschriebenen Fantasy-Romane überhaupt. Rothfuss\' Prosa ist pure Magie.'},
    {id:'der-augensammler',title:'Der Augensammler',author:'Sebastian Fitzek',genre:'Psychothriller',rating:4.1,year:2010,cover:'https://books.google.com/books/content?id=cxl5QwAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Ein Serienmörder entführt Kinder und gibt den Eltern eine Frist: 45 Stunden. Als einzigen Hinweis hinterlässt er ein Glasauge in der Augenhöhle seines letzten Opfers. Der Countdown läuft rückwärts.',reason:'Fitzek erzählt die Geschichte rückwärts — ein einzigartiges Erzählexperiment, das den Thriller neu erfindet.'},
    {id:'die-schneeschwester',title:'Die Schneeschwester',author:'Maja Lunde',genre:'Nordic Noir / Mystery',rating:4.0,year:2018,cover:'https://books.google.com/books/content?id=gGRKDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'btb',summary:'Julian begegnet im Dezember einem geheimnisvollen Mädchen namens Hedvig, das nur er sehen kann. Sie nimmt ihn mit auf eine Reise durch die Adventszeit — zu einem Abschied, der alles verändert.',reason:'Lunde verbindet skandinavische Melancholie mit einer Geschichte über Verlust und Hoffnung.'},
    {id:'inferno',title:'Inferno',author:'Dan Brown',genre:'Thriller / Mystery',rating:4.0,year:2013,cover:'https://books.google.com/books/content?id=otSCXUPSAgMC&printsec=frontcover&img=1&zoom=1',publisher:'Bastei Lübbe',summary:'Robert Langdon erwacht in einem Krankenhaus in Florenz — ohne Erinnerung an die letzten zwei Tage. Jemand will ihn töten. Die einzige Spur: Dantes „Göttliche Komödie" und eine tickende biologische Bombe.',reason:'Dan Brown auf Hochtouren. Kunst, Geschichte und Verschwörung in den Gassen von Florenz.'},
    {id:'die-verlorene',title:'Die Verlorene',author:'Simon Beckett',genre:'Thriller / Krimi',rating:4.1,year:2022,cover:'https://books.google.com/books/content?id=CeFdEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Rowohlt',summary:'Forensiker David Hunter wird zu einem mysteriösen Fund in den Backwaters von Essex gerufen. Doch was als Routinefall beginnt, entwickelt sich zu seinem gefährlichsten Einsatz — denn der Mörder ist noch da.',reason:'Beckett liefert forensische Präzision und Hochspannung. Sein bester Hunter-Roman seit Jahren.'},
    {id:'der-process',title:'Der Process',author:'Franz Kafka',genre:'Klassiker / Mystery',rating:4.1,year:1925,cover:'https://books.google.com/books/content?id=8B_4DwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Fischer',summary:'Josef K. wird an seinem 30. Geburtstag verhaftet — ohne zu erfahren, wofür. Der absurde Prozess zieht sich hin, die Bürokratie ist undurchdringlich, und das Urteil scheint längst festzustehen.',reason:'Kafkas verstörendstes Werk. 100 Jahre alt und aktueller denn je.'},
    {id:'die-drei-sonnen',title:'Die drei Sonnen',author:'Liu Cixin',genre:'Science Fiction',rating:4.1,year:2006,cover:'https://books.google.com/books/content?id=idMiDQAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Während der chinesischen Kulturrevolution sendet eine Astrophysikerin ein Signal ins All. Jahrzehnte später antwortet eine außerirdische Zivilisation — und die Menschheit steht vor der größten Entscheidung ihrer Geschichte.',reason:'Hugo Award-Gewinner. Hard-Sci-Fi aus China, die den Westen im Sturm erobert hat. Verfilmt auf Netflix.'},
    {id:'still',title:'Still',author:'Zoran Drvenkar',genre:'Psychothriller',rating:4.0,year:2009,cover:'https://books.google.com/books/content?id=Y5N5QgAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'Vier Freundinnen gründen eine Agentur für Entschuldigungen — sie entschuldigen sich bei den Menschen, die ihre Klienten verletzt haben. Bis ein Klient sie zu einer Leiche schickt und sagt: „Entschuldigt euch bei ihr."',reason:'Drvenkar schreibt einen der originellsten deutschen Thriller. Verstörend, klug und absolut einzigartig.'},
    {id:'qualityland',title:'QualityLand',author:'Marc-Uwe Kling',genre:'Science Fiction / Humor',rating:4.2,year:2017,cover:'https://books.google.com/books/content?id=1rg4DwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Ullstein',summary:'In einer Zukunft, in der Algorithmen über Jobs, Liebe und Status entscheiden, will Maschinenverschrotter Peter Arbeitsloser ein Produkt zurückgeben, das er nicht bestellt hat. Unmöglich, sagt das System.',reason:'Kling verbindet scharfe Gesellschaftskritik mit brillantem Humor. Wie „1984" — aber lustig.'},
    {id:'die-schule-der-magischen-tiere',title:'Blackout',author:'Marc Elsberg',genre:'Thriller / Science Fiction',rating:4.3,year:2012,cover:'https://books.google.com/books/content?id=rPTfAAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Blanvalet',summary:'An einem kalten Februartag fällt in ganz Europa der Strom aus. Während die Zivilisation zusammenbricht, versucht der IT-Spezialist Piero Manzano herauszufinden, wer dahintersteckt — und wird selbst zum Verdächtigen.',reason:'Der Techno-Thriller, der Deutschland wachgerüttelt hat. Realistisch, beängstigend und ein Pageturner.'},
    {id:'passagier-23',title:'Passagier 23',author:'Sebastian Fitzek',genre:'Psychothriller / Mystery',rating:4.1,year:2014,cover:'https://books.google.com/books/content?id=rKVxBgAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Jedes Jahr verschwinden auf Kreuzfahrtschiffen durchschnittlich 23 Passagiere spurlos. Martin Schwartz\' Frau und Sohn gehören dazu. Fünf Jahre später erhält er einen Anruf: Sein Sohn ist wieder aufgetaucht — auf demselben Schiff.',reason:'Fitzek nimmt sich die klaustrophobische Welt der Kreuzfahrtschiffe vor. Ein albtraumhaft guter Thriller.'},
    {id:'der-schatten-des-windes',title:'Der Schatten des Windes',author:'Carlos Ruiz Zafón',genre:'Mystery / Historisch',rating:4.3,year:2001,cover:'https://books.google.com/books/content?id=CQFKSwAACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'S. Fischer',summary:'Barcelona, 1945: Daniel Sempere findet auf dem „Friedhof der Vergessenen Bücher" einen Roman, der sein Leben verändert. Als er den Autor sucht, erfährt er, dass jemand systematisch alle seine Bücher vernichtet.',reason:'15 Millionen Exemplare weltweit. Eine Hymne an die Literatur, eingebettet in ein düsteres Barcelona.'},
    {id:'das-joshua-profil',title:'Das Joshua-Profil',author:'Sebastian Fitzek',genre:'Psychothriller',rating:4.0,year:2015,cover:'https://books.google.com/books/content?id=Xmj8oAEACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Max Rhode ist Schriftsteller. Seine Plots werden wahr — jemand setzt seine fiktiven Verbrechen in die Realität um. Als die Polizei ihn verdächtigt, muss Max seinen eigenen Geschichten entkommen.',reason:'Meta-Thriller vom Feinsten: Fitzek spielt mit der Grenze zwischen Fiktion und Realität.'},
    {id:'recursion',title:'Recursion',author:'Blake Crouch',genre:'Science Fiction / Thriller',rating:4.3,year:2019,cover:'https://books.google.com/books/content?id=T8mDDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Goldmann',summary:'Menschen erinnern sich plötzlich an ein Leben, das sie nie gelebt haben. Falsche Erinnerungen breiten sich wie eine Epidemie aus. Detective Barry Sutton und Neurowissenschaftlerin Helena Smith suchen den Ursprung.',reason:'Crouch toppt „Dark Matter" noch. Ein Mind-Bending-Thriller über Erinnerung und Identität.'},
    {id:'der-spinnenfaenger',title:'Der Spinnenfänger',author:'Jussi Adler-Olsen',genre:'Nordic Noir / Krimi',rating:4.0,year:2008,cover:'https://books.google.com/books/content?id=JQAADAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'dtv',summary:'Carl Mørck wird ins Sonderdezernat Q versetzt — die Abteilung für ungelöste Fälle. Sein erster Fall: Eine Politikerin, die vor fünf Jahren verschwand. Die offizielle Theorie: Selbstmord. Die Wahrheit: weitaus schlimmer.',reason:'Der Auftakt der legendären Dezernat-Q-Reihe. Skandinavischer Krimi auf Weltklasse-Niveau.'},
    {id:'fahrenheit-451',title:'Fahrenheit 451',author:'Ray Bradbury',genre:'Science Fiction / Klassiker',rating:4.0,year:1953,cover:'https://books.google.com/books/content?id=AU9YDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Diogenes',summary:'In einer Zukunft, in der Bücher verboten sind, ist Guy Montag ein Feuerwehrmann — seine Aufgabe: Bücher verbrennen. Bis er eines Tages eines liest und alles in Frage stellt.',reason:'Bradburys Dystopie über eine Welt ohne Bücher. Prophetisch, poetisch und unverzichtbar.'},
    {id:'der-goldene-handschuh',title:'Der Goldene Handschuh',author:'Heinz Strunk',genre:'Krimi / Horror',rating:4.0,year:2016,cover:'https://books.google.com/books/content?id=L0YlDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Rowohlt',summary:'Hamburg, 1970er Jahre: Fritz Honka, ein unscheinbarer Mann, sitzt jede Nacht in der Kneipe „Zum Goldenen Handschuh". Was niemand ahnt: In seiner Dachwohnung stapeln sich die Leichen.',reason:'Basiert auf einem wahren Fall. Strunk schreibt schonungslos und literarisch zugleich. Nichts für schwache Nerven.'},
    {id:'die-purpurnen-fluesse',title:'Die purpurnen Flüsse',author:'Jean-Christophe Grangé',genre:'Thriller / Krimi',rating:4.0,year:1998,cover:'https://books.google.com/books/content?id=Vx4LEAAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Bastei Lübbe',summary:'Zwei Ermittler stoßen unabhängig voneinander auf bizarre Morde in den französischen Alpen. Als sich ihre Fälle kreuzen, entdecken sie ein Geheimnis, das Generationen zurückreicht.',reason:'Grangés Meisterwerk. Ein atmosphärischer Thriller zwischen Bergwildnis und akademischem Wahnsinn.'},
    {id:'stiller',title:'Stiller',author:'Max Frisch',genre:'Klassiker / Mystery',rating:4.1,year:1954,cover:'https://books.google.com/books/content?id=Z5sQAQAAIAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Suhrkamp',summary:'Ein Mann wird an der Schweizer Grenze verhaftet. Er behauptet, nicht der vermisste Bildhauer Anatol Stiller zu sein. Alle Beweise sprechen gegen ihn — doch er weigert sich, seine Identität anzunehmen.',reason:'Frischs Meisterwerk über Identität, Selbstbild und die Unmöglichkeit, ein anderer zu werden.'},
    {id:'tender-is-the-flesh',title:'Tender is the Flesh',author:'Agustina Bazterrica',genre:'Horror / Science Fiction',rating:4.0,year:2017,cover:'https://books.google.com/books/content?id=XNy0DwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Suhrkamp',summary:'In einer Zukunft, in der eine Seuche alle Tiere befallen hat, wird menschliches Fleisch industriell produziert. Marcos arbeitet in einer Verarbeitungsanlage — bis ihm ein „besonderes Exemplar" zugeteilt wird.',reason:'Verstörend, brillant und erschreckend plausibel. Ein dystopischer Roman, der unter die Haut geht.'},
    {id:'die-frau-des-zeitreisenden',title:'Die Frau des Zeitreisenden',author:'Audrey Niffenegger',genre:'Science Fiction / Liebesroman',rating:4.0,year:2003,cover:'https://books.google.com/books/content?id=s4UNx_F2xNcC&printsec=frontcover&img=1&zoom=1',publisher:'S. Fischer',summary:'Henry DeTamble hat eine genetische Störung: Er reist unkontrolliert durch die Zeit. Seine Frau Clare muss mit seiner ständigen Abwesenheit leben — und mit der Angst, dass er eines Tages nicht zurückkehrt.',reason:'Eine der ungewöhnlichsten Liebesgeschichten der Literatur. Zeitreise trifft auf tiefe Emotionen.'},
    {id:'die-chemie-des-todes',title:'Die Chemie des Todes',author:'Simon Beckett',genre:'Thriller / Krimi',rating:4.2,year:2006,cover:'https://books.google.com/books/content?id=P0kw_2akrZ8C&printsec=frontcover&img=1&zoom=1',publisher:'Rowohlt',summary:'Dr. David Hunter hat sich in ein englisches Dorf zurückgezogen, um seine Vergangenheit zu vergessen. Als eine Frau brutal ermordet wird, kann nur sein Spezialwissen über Verwesung den Mörder überführen.',reason:'Der Auftakt der David-Hunter-Reihe. Forensik-Thriller mit wissenschaftlicher Präzision und britischem Flair.'},
    {id:'zero',title:'Zero',author:'Marc Elsberg',genre:'Thriller / Science Fiction',rating:4.1,year:2014,cover:'https://books.google.com/books/content?id=vwK8oAEACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Blanvalet',summary:'Cynthia Bonsant recherchiert über eine mysteriöse Online-Aktivistengruppe namens Zero. Die warnt vor der totalen Überwachung durch Datenkonzerne — doch ist Zero Retter oder Gefahr?',reason:'Elsbergs Techno-Thriller über Big Data und Privatsphäre. Erschreckend aktuell und spannend.'},
    {id:'die-vergessenen',title:'Die Vergessenen',author:'Ellen Sandberg',genre:'Mystery / Historisch',rating:4.0,year:2019,cover:'https://books.google.com/books/content?id=GHhSDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Penguin',summary:'Manolis erbt ein Haus in München und findet im Keller verstörende Dokumente. Die Spur führt zurück in die NS-Zeit — und zu einem Geheimnis, das Familien über Generationen hinweg zerstört.',reason:'Sandberg verwebt Gegenwart und Geschichte zu einem packenden Mystery-Roman über Schuld und Verdrängung.'},
    {id:'der-schweigende',title:'Der Schweigende',author:'Alex Michaelides',genre:'Psychothriller',rating:4.1,year:2019,cover:'https://books.google.com/books/content?id=OLqJDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Droemer',summary:'Alicia Berenson erschießt ihren Mann und schweigt seitdem. Therapeut Theo Faber ist besessen davon, sie zum Sprechen zu bringen — doch die Wahrheit hinter dem Schweigen ist schockierender als erwartet.',reason:'Das meistverkaufte Thriller-Debüt seit Jahren. Ein perfekt konstruierter Psychothriller mit einem atemberaubenden Twist.'},
    {id:'solaris',title:'Solaris',author:'Stanisław Lem',genre:'Science Fiction / Klassiker',rating:4.2,year:1961,cover:'https://books.google.com/books/content?id=IoyvDwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Suhrkamp',summary:'Auf der Raumstation über dem Planeten Solaris geschehen unerklärliche Dinge. Der Ozean des Planeten scheint lebendig zu sein — und konfrontiert die Forscher mit ihren tiefsten Ängsten und Erinnerungen.',reason:'Lems philosophisches Meisterwerk über die Grenzen menschlicher Erkenntnis. Zweimal verfilmt, nie erreicht.'},
    {id:'die-geliehene-schuld',title:'Die geliehene Schuld',author:'Claire Winter',genre:'Historisch / Thriller',rating:4.0,year:2020,cover:'https://books.google.com/books/content?id=WnW4DwAAQBAJ&printsec=frontcover&img=1&zoom=1',publisher:'Diana',summary:'Berlin, 1949: Zwei Schwestern, getrennt durch den Eisernen Vorhang. Als eine von ihnen in eine Geheimdienstaffäre verwickelt wird, beginnt ein Wettlauf gegen die Zeit.',reason:'Winter verbindet deutsche Nachkriegsgeschichte mit einem packenden Spionagethriller.'},
    {id:'das-lied-von-eis-und-feuer',title:'Das Lied von Eis und Feuer',author:'George R.R. Martin',genre:'Fantasy',rating:4.4,year:1996,cover:'https://books.google.com/books/content?id=5NomkK4EV68C&printsec=frontcover&img=1&zoom=1',publisher:'Blanvalet',summary:'In einer Welt voller Intrigen, Drachen und einer nahenden Bedrohung aus dem Norden kämpfen verschiedene Familien um den Eisernen Thron. Niemand ist sicher — nicht einmal die Hauptfiguren.',reason:'Die Vorlage zu „Game of Thrones". Martins Epos definierte das Fantasy-Genre neu.'},
    {id:'der-vorleser',title:'Der Vorleser',author:'Bernhard Schlink',genre:'Klassiker / Historisch',rating:4.0,year:1995,cover:'https://books.google.com/books/content?id=YYMd0o9UEJgC&printsec=frontcover&img=1&zoom=1',publisher:'Diogenes',summary:'Michael Berg hat als 15-Jähriger eine Affäre mit der 36-jährigen Hanna. Jahre später sitzt er als Jurastudent im Gerichtssaal — und erkennt sie als Angeklagte in einem NS-Prozess wieder.',reason:'Weltweit über 10 Millionen Exemplare. Schlinks Roman über Schuld, Scham und die Last der Geschichte.'},
    {id:'das-geisterschiff',title:'Das Geisterschiff',author:'Chris Kuzneski',genre:'Thriller / Mystery',rating:4.0,year:2014,cover:'https://books.google.com/books/content?id=nNXqoAEACAAJ&printsec=frontcover&img=1&zoom=1',publisher:'Heyne',summary:'Vor der Küste Floridas wird ein Geisterschiff entdeckt — die Besatzung ist verschwunden, das Logbuch endet mit einer kryptischen Nachricht. Jonathon Payne und D.J. Jones folgen einer tödlichen Spur.',reason:'Kuzneski verbindet historische Rätsel mit moderner Action. Ein Pageturner für Abenteurer.'}
  ];

  // ─── Datumsbasierte Rotation ───
  function getDayIndex() {
    var now = new Date();
    var start = new Date(2026, 1, 17); // 17. Feb 2026 als Tag 0
    var diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
    return Math.max(0, diff);
  }

  function seededShuffle(arr, seed) {
    var copy = arr.slice();
    var m = copy.length, t, i;
    var s = seed;
    while (m) {
      s = (s * 16807 + 0) % 2147483647;
      i = s % m--;
      t = copy[m]; copy[m] = copy[i]; copy[i] = t;
    }
    return copy;
  }

  function getBooksForDay(dayOffset) {
    var dayIndex = getDayIndex() - (dayOffset || 0);
    if (dayIndex < 0) dayIndex = 0;
    // Jeder Tag bekommt 3 Bücher, Rotation über den gesamten Pool
    var shuffled = seededShuffle(bookPool, 42);
    var totalSets = Math.ceil(shuffled.length / 3);
    var setIndex = dayIndex % totalSets;
    return shuffled.slice(setIndex * 3, setIndex * 3 + 3);
  }

  function formatDateDE(d) {
    var months = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    return d.getDate() + '. ' + months[d.getMonth()] + ' ' + d.getFullYear();
  }

  function getInitials(name) {
    return name.split(/\s+/).map(function(w) { return w[0] || ''; }).join('').substring(0, 2).toUpperCase();
  }

  function renderStars(rating) {
    var full = Math.floor(rating);
    var html = '<span class="lit">';
    for (var i = 0; i < full; i++) html += '&#9733;';
    html += '</span>';
    for (var j = full; j < 5; j++) html += '&#9733;';
    return html;
  }

  // ─── Dynamisches Rendering der Tagesvorschläge ───
  function renderDailyBooks() {
    var today = new Date();
    var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    var metaEl = document.getElementById('metaInfo');
    if (metaEl) {
      metaEl.innerHTML = '<span>' + formatDateDE(today) + '</span><span class="meta-sep">|</span><span>Täglich um 08:00</span><span class="meta-sep">|</span><span>Nächste: ' + formatDateDE(tomorrow) + '</span>';
    }

    var books = getBooksForDay(0);
    var grid = document.getElementById('dailyGrid');
    if (!grid) return;
    var html = '';

    books.forEach(function(book) {
      html += '<article class="book-card" data-book-id="' + book.id + '" data-cover="' + book.cover + '" data-title="' + escapeHtml(book.title) + '" data-author="' + escapeHtml(book.author) + '" data-rating="' + book.rating + '">';
      html += '<div class="card-header"><div class="cover-wrap">';
      html += '<img src="' + book.cover + '" alt="' + escapeHtml(book.title) + '" data-title="' + escapeHtml(book.title) + '" onload="checkCoverOnLoad(this)" onerror="handleCoverError(this,this.dataset.title)">';
      html += '</div><div class="card-info">';
      html += '<span class="genre-label">' + escapeHtml(book.genre) + '</span>';
      html += '<div class="book-title">' + escapeHtml(book.title) + '</div>';
      html += '<div class="author-line"><span class="author-avatar" aria-hidden="true">' + getInitials(book.author) + '</span>';
      html += '<span class="author-name">' + escapeHtml(book.author) + '</span></div>';
      html += '<div class="rating-row"><span class="star-display">' + renderStars(book.rating) + '</span>';
      html += '<span class="rating-num">' + book.rating + '</span>';
      html += '<span class="year-tag">' + book.year + '</span></div>';
      html += '<span class="lang-tag">Deutsche Ausgabe &middot; ' + escapeHtml(book.publisher) + '</span>';
      html += '</div></div>';
      html += '<hr class="card-divider">';
      html += '<div class="section-label">Zusammenfassung</div>';
      html += '<p class="book-summary">' + escapeHtml(book.summary) + '</p>';
      html += '<div class="reason-box"><div class="section-label">Warum lesenswert</div>';
      html += '<p class="reason-text">' + escapeHtml(book.reason) + '</p></div>';
      html += '<div class="track-row">';
      html += '<button class="track-btn needs-login" onclick="trackBook(this,\'merkliste\')" data-status="merkliste"><span class="track-icon">&#9203;</span>Merken</button>';
      html += '<button class="track-btn needs-login" onclick="trackBook(this,\'lese-ich\')" data-status="lese-ich"><span class="track-icon">&#128214;</span>Lese ich</button>';
      html += '<button class="track-btn needs-login" onclick="trackBook(this,\'gelesen\')" data-status="gelesen"><span class="track-icon">&#9733;</span>Gelesen</button>';
      html += '</div></article>';
    });

    grid.innerHTML = html;
    buildSidebar();
  }

  // ─── Archiv dynamisch füllen ───
  function renderArchive() {
    var archiveEl = document.getElementById('archiveList');
    if (!archiveEl) return;
    var html = '';
    var dayIndex = getDayIndex();
    var maxArchive = Math.min(dayIndex, 7); // Letzte 7 Tage

    for (var d = 1; d <= maxArchive; d++) {
      var pastDate = new Date(); pastDate.setDate(pastDate.getDate() - d);
      var books = getBooksForDay(d);
      html += '<div class="history-day"><div class="history-date">' + formatDateDE(pastDate) + '</div><div class="history-books">';
      books.forEach(function(book) {
        html += '<div class="history-item">';
        html += '<div class="history-cover"><img src="' + book.cover + '" alt="' + escapeHtml(book.title) + '" data-title="' + escapeHtml(book.title) + '" onload="checkCoverOnLoad(this)" onerror="handleCoverError(this,this.dataset.title)"></div>';
        html += '<div class="history-meta"><div class="history-title">' + escapeHtml(book.title) + '</div>';
        html += '<div class="history-author">' + escapeHtml(book.author) + '</div>';
        html += '<div class="history-rating">' + renderStars(book.rating) + ' ' + book.rating + '</div></div>';
        html += '</div>';
      });
      html += '</div></div>';
    }

    archiveEl.innerHTML = html || '<div style="padding:8px;color:var(--text-muted);font-size:0.7rem;">Noch kein Archiv vorhanden.</div>';
  }

  // ─── Build Sidebar from book cards ───
  function buildSidebar() {
    var container = document.getElementById('sidebarBooks');
    var cards = document.querySelectorAll('.book-card');
    var html = '';

    cards.forEach(function(card) {
      var bookId = card.getAttribute('data-book-id');
      var cover = card.getAttribute('data-cover');
      var title = card.getAttribute('data-title');
      var author = card.getAttribute('data-author');
      var rating = card.getAttribute('data-rating');

      html += '<div class="sidebar-card">';
      html += '<div class="sidebar-cover sidebar-clickable" role="button" tabindex="0" aria-label="' + title + ' &mdash; Details anzeigen" onclick="showSuggestionsOverlay()" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();showSuggestionsOverlay()}"><img src="' + cover + '" alt="' + escapeHtml(title) + '" data-title="' + escapeHtml(title) + '" onload="checkCoverOnLoad(this)" onerror="handleCoverError(this,this.dataset.title)"></div>';
      html += '<div class="sidebar-info">';
      html += '<div class="sidebar-book-title sidebar-clickable" role="button" tabindex="0" onclick="showSuggestionsOverlay()" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();showSuggestionsOverlay()}">' + title + '</div>';
      html += '<div class="sidebar-author">' + author + '</div>';
      html += '<div class="sidebar-rating"><span class="lit">&#9733;</span> ' + rating + '</div>';
      html += '<div class="sidebar-track-row">';
      html += '<button class="sidebar-track-btn" data-book-id="' + bookId + '" data-status="merkliste" onclick="trackFromSidebar(this)" aria-label="' + title + ' merken">&#9203;</button>';
      html += '<button class="sidebar-track-btn" data-book-id="' + bookId + '" data-status="lese-ich" onclick="trackFromSidebar(this)" aria-label="' + title + ' lese ich">&#128214;</button>';
      html += '<button class="sidebar-track-btn" data-book-id="' + bookId + '" data-status="gelesen" onclick="trackFromSidebar(this)" aria-label="' + title + ' gelesen">&#9733;</button>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function trackFromSidebar(btn) {
    if (!currentUser) return;
    var bookId = btn.getAttribute('data-book-id');
    var status = btn.getAttribute('data-status');
    var card = document.querySelector('.book-card[data-book-id="' + bookId + '"]');
    var isActive = btn.classList.contains('active');

    if (isActive) {
      db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).delete();
      var allBtns = btn.parentElement.querySelectorAll('.sidebar-track-btn');
      allBtns.forEach(function(b) { b.classList.remove('active'); });
    } else {
      var bookData = {
        title: card.getAttribute('data-title'),
        author: card.getAttribute('data-author'),
        coverUrl: card.getAttribute('data-cover'),
        rating: parseFloat(card.getAttribute('data-rating') || 0),
        status: status,
        addedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).set(bookData);
      var allBtns = btn.parentElement.querySelectorAll('.sidebar-track-btn');
      allBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
    }
    setTimeout(loadUserBooks, 500);
  }

  // ─── Book Tracking (from grid cards) ───
  function getBookData(card) {
    return {
      title: card.querySelector('.book-title').textContent,
      author: card.querySelector('.author-name').textContent,
      coverUrl: card.querySelector('.cover-wrap img') ? card.querySelector('.cover-wrap img').src : '',
      rating: card.querySelector('.rating-num') ? parseFloat(card.querySelector('.rating-num').textContent) : 0
    };
  }

  function announceToSR(msg) {
    var el = document.getElementById('srAnnounce');
    el.textContent = '';
    setTimeout(function() { el.textContent = msg; }, 100);
  }

  var _loginToastTimer = null;
  var _toastPaused = false;
  function showLoginToast() {
    var toast = document.getElementById('loginToast');
    toast.classList.add('visible');
    _toastPaused = false;
    if (_loginToastTimer) clearTimeout(_loginToastTimer);
    _loginToastTimer = setTimeout(function hideToast() {
      if (_toastPaused) { _loginToastTimer = setTimeout(hideToast, 1000); return; }
      toast.classList.remove('visible');
    }, 8000);
  }
  // Pause toast on hover/focus
  (function() {
    var toast = document.getElementById('loginToast');
    toast.addEventListener('mouseenter', function() { _toastPaused = true; });
    toast.addEventListener('mouseleave', function() { _toastPaused = false; });
    toast.addEventListener('focusin', function() { _toastPaused = true; });
    toast.addEventListener('focusout', function() { _toastPaused = false; });
  })();

  function trackBook(btn, status) {
    if (!currentUser) { showLoginToast(); return; }
    var card = btn.closest('.book-card');
    var bookId = card.getAttribute('data-book-id');
    var bookData = getBookData(card);
    var allBtns = card.querySelectorAll('.track-btn');
    var isActive = btn.classList.contains('active');

    if (isActive) {
      db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).delete();
      allBtns.forEach(function(b) { b.classList.remove('active'); });
      announceToSR(bookData.title + ' wurde entfernt.');
    } else {
      bookData.status = status;
      bookData.addedAt = firebase.firestore.FieldValue.serverTimestamp();
      db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).set(bookData);
      allBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var statusLabels = {'merkliste':'Merkliste','lese-ich':'Lese ich','gelesen':'Gelesen'};
      announceToSR(bookData.title + ' wurde zu ' + (statusLabels[status] || status) + ' hinzugefügt.');
    }
    setTimeout(loadUserBooks, 500);
  }

  // ─── Load & Render User Books ───
  function loadUserBooks() {
    if (!currentUser) return;
    db.collection('users').doc(currentUser.uid).collection('books')
      .orderBy('addedAt', 'desc')
      .get()
      .then(function(snapshot) {
        var books = { merkliste: [], 'lese-ich': [], gelesen: [] };
        snapshot.forEach(function(doc) {
          var data = doc.data();
          data.id = doc.id;
          if (books[data.status]) books[data.status].push(data);
        });

        // Update grid card buttons
        document.querySelectorAll('.book-card').forEach(function(card) {
          var bookId = card.getAttribute('data-book-id');
          var btns = card.querySelectorAll('.track-btn');
          btns.forEach(function(b) { b.classList.remove('active'); });
          snapshot.forEach(function(doc) {
            if (doc.id === bookId) {
              var st = doc.data().status;
              btns.forEach(function(b) {
                if (b.getAttribute('data-status') === st) b.classList.add('active');
              });
            }
          });
        });

        // Update sidebar buttons
        document.querySelectorAll('.sidebar-track-btn').forEach(function(btn) {
          btn.classList.remove('active');
          var bookId = btn.getAttribute('data-book-id');
          var btnStatus = btn.getAttribute('data-status');
          snapshot.forEach(function(doc) {
            if (doc.id === bookId && doc.data().status === btnStatus) {
              btn.classList.add('active');
            }
          });
        });

        renderDashboard(books);
      });
  }

  function renderDashboard(books) {
    var container = document.getElementById('dashCategories');
    var categories = [
      { key: 'lese-ich', label: 'Lese ich aktuell', icon: '&#128214;' },
      { key: 'merkliste', label: 'M\u00F6chte ich lesen', icon: '&#9203;' },
      { key: 'gelesen', label: 'Habe ich gelesen', icon: '&#9733;' }
    ];

    // ─── Statistics Section ───
    var allBooks = (books['lese-ich'] || []).concat(books['merkliste'] || []).concat(books['gelesen'] || []);
    var totalBooks = allBooks.length;
    var readBooks = (books['gelesen'] || []).length;
    var readingBooks = (books['lese-ich'] || []).length;
    var wantBooks = (books['merkliste'] || []).length;

    // Average hearts for gelesen
    var heartsSum = 0; var heartsCount = 0;
    (books['gelesen'] || []).forEach(function(b) {
      if (b.hearts) { heartsSum += b.hearts; heartsCount++; }
    });
    var avgHearts = heartsCount > 0 ? (heartsSum / heartsCount).toFixed(1) : '–';

    // Genre stats
    var genreCount = {};
    allBooks.forEach(function(b) {
      (b.genres || []).forEach(function(g) { genreCount[g] = (genreCount[g] || 0) + 1; });
    });
    var topGenres = Object.keys(genreCount).sort(function(a, b) { return genreCount[b] - genreCount[a]; });

    // Books this year
    var thisYear = new Date().getFullYear();
    var booksThisYear = (books['gelesen'] || []).filter(function(b) { return b.readYear === thisYear; }).length;

    var html = '';

    // Format-Statistik (Physisch vs. Digital)
    var physCount = 0; var digiCount = 0;
    allBooks.forEach(function(b) {
      if (b.readFormat === 'physisch') physCount++;
      else if (b.readFormat === 'digital') digiCount++;
    });

    if (totalBooks > 0) {
      html += '<div class="stats-section">';
      html += '<h2 class="stats-title">Lesestatistiken</h2>';
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-number">' + readBooks + '</div><div class="stat-label">Gelesen insgesamt</div></div>';
      html += '<div class="stat-card"><div class="stat-number">' + booksThisYear + '</div><div class="stat-label">Gelesen ' + thisYear + '</div></div>';
      html += '<div class="stat-card"><div class="stat-number">' + wantBooks + '</div><div class="stat-label">M\u00F6chte ich lesen</div></div>';
      html += '<div class="stat-card"><div class="stat-number">' + physCount + '</div><div class="stat-label">Physisch</div></div>';
      html += '<div class="stat-card"><div class="stat-number">' + digiCount + '</div><div class="stat-label">Digital / Kindle</div></div>';
      html += '</div>';
      if (topGenres.length > 0) {
        html += '<div class="stats-genres">';
        topGenres.forEach(function(g) {
          html += '<span class="stats-genre-pill">' + g + ' (' + genreCount[g] + ')</span>';
        });
        html += '</div>';
      }
      html += '</div>';
    }

    categories.forEach(function(cat) {
      var list = books[cat.key] || [];
      var displayList = list;
      var displayCount = list.length;

      if (cat.key === 'gelesen' && list.length > 0) {
        var sortDir = window._gelesenSort || 'newest';
        var filterYear = window._gelesenYear || 'all';

        // Collect available years
        var yearSet = {};
        list.forEach(function(b) { if (b.readYear) yearSet[b.readYear] = true; });
        var years = Object.keys(yearSet).map(Number).sort(function(a,b) { return b - a; });

        // Filter by year
        if (filterYear !== 'all') {
          displayList = list.filter(function(b) { return b.readYear === filterYear; });
          displayCount = displayList.length;
        } else {
          displayList = list.slice();
          displayCount = list.length;
        }

        // Sort
        displayList.sort(function(a, b) {
          var aVal = (a.readYear || 0) * 100 + (a.readMonth || 0);
          var bVal = (b.readYear || 0) * 100 + (b.readMonth || 0);
          return sortDir === 'newest' ? bVal - aVal : aVal - bVal;
        });
      }

      html += '<div class="book-category">';
      html += '<div class="category-header">';
      html += '<span class="category-icon" aria-hidden="true">' + cat.icon + '</span>';
      html += '<h2 class="category-title">' + cat.label + ' <span class="category-count">(' + displayCount + (cat.key === 'gelesen' && filterYear !== 'all' ? ' / ' + list.length : '') + ')</span></h2>';
      if (cat.key === 'gelesen' && list.length > 0) {
        html += '<div class="filter-row">';
        html += '<select class="filter-year-select active" onchange="setGelesenSort(this.value)">';
        html += '<option value="newest"' + (sortDir === 'newest' ? ' selected' : '') + '>Neueste zuerst</option>';
        html += '<option value="oldest"' + (sortDir === 'oldest' ? ' selected' : '') + '>\u00C4lteste zuerst</option>';
        html += '</select>';
        if (years.length > 0) {
          html += '<select class="filter-year-select active" onchange="setGelesenYear(this.value)">';
          html += '<option value="all"' + (filterYear === 'all' ? ' selected' : '') + '>Alle Jahre</option>';
          years.forEach(function(y) {
            html += '<option value="' + y + '"' + (filterYear === y ? ' selected' : '') + '>' + y + '</option>';
          });
          html += '</select>';
        }
        html += '</div>';
      }
      html += '</div>';
      html += '<div class="category-books">';

      if (displayList.length === 0) {
        html += '<div class="category-empty">Noch keine B\u00FCcher in dieser Kategorie.</div>';
      } else {
        displayList.forEach(function(book) {
          html += '<div class="cat-book-item">';

          // ── Row 1: Cover + Title/Author/Hearts ──
          html += '<div class="cat-book-header">';
          html += '<div class="cat-book-cover sidebar-clickable" role="button" tabindex="0" aria-label="' + escapeHtml(book.title) + ' &mdash; Details anzeigen" onclick="showBookDetail(\'' + book.id + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();showBookDetail(\'' + book.id + '\')}">';
          html += '<img src="' + (book.coverUrl || '') + '" alt="Cover: ' + escapeHtml(book.title) + '" data-title="' + escapeHtml(book.title) + '" onload="checkCoverOnLoad(this)" onerror="handleCoverError(this,this.dataset.title)"></div>';
          html += '<div class="cat-book-info">';
          var bookGenres = book.genres || [];
          html += '<div class="cat-book-title-row">';
          html += '<span class="cat-book-title sidebar-clickable" role="button" tabindex="0" onclick="showBookDetail(\'' + book.id + '\')" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();showBookDetail(\'' + book.id + '\')}">' + escapeHtml(book.title) + '</span>';
          if (bookGenres.length > 0) {
            html += '<span class="cat-book-genres">';
            bookGenres.forEach(function(g) { html += '<span class="genre-pill">' + escapeHtml(g) + '</span>'; });
            html += '</span>';
          }
          html += '</div>';
          html += '<div class="cat-book-author">' + escapeHtml(book.author) + '</div>';

          // Meta row: hearts + recommended
          var hearts = book.hearts || 0;
          var hasMetaContent = hearts > 0 || book.recommendedBy;
          if (hasMetaContent) {
            html += '<div class="cat-book-meta">';
            if (hearts > 0) {
              html += '<div class="cat-book-hearts">';
              for (var h = 1; h <= 5; h++) {
                html += '<span class="' + (h <= hearts ? 'filled' : '') + '">&hearts;</span>';
              }
              html += '</div>';
            }
            if (book.recommendedBy) {
              html += '<div class="cat-book-recommended">Empfohlen von ' + escapeHtml(book.recommendedBy) + '</div>';
            }
            html += '</div>';
          }
          html += '</div>';
          html += '</div>';

          // ── Row 2: Details (indented under cover) ──
          var rawLink = book.bookLink || book.buyLink || book.infoLink || '';
          var bookLink = rawLink;
          if (bookLink && (bookLink.indexOf('books.google') >= 0 || bookLink.indexOf('googleapis.com') >= 0 || bookLink.indexOf('covers.openlibrary') >= 0 || bookLink.indexOf('openlibrary.org/b') >= 0)) {
            bookLink = '';
          }
          var quotes = book.quotes || [];
          var hasDetails = bookLink || book.fazit || quotes.length > 0;

          if (hasDetails) {
            html += '<div class="cat-book-details">';
            if (book.fazit || quotes.length > 0) {
              html += '<div class="cat-book-cards-row">';
              if (book.fazit) {
                html += '<div class="cat-book-card-box">';
                html += '<div class="cat-book-card-label">Meine Notizen zum Buch</div>';
                html += '<div class="cat-book-card-text">&bdquo;' + escapeHtml(book.fazit) + '&ldquo;</div>';
                html += '</div>';
              }
              if (quotes.length > 0) {
                html += '<div class="cat-book-card-box">';
                html += '<div class="cat-book-card-label">Meine Lieblingszitate aus dem Buch</div>';
                quotes.forEach(function(q) {
                  html += '<div class="cat-book-card-quote">&bdquo;' + escapeHtml(q) + '&ldquo;</div>';
                });
                html += '</div>';
              }
              html += '</div>';
            }
            if (bookLink) {
              html += '<div class="cat-book-links">';
              html += '<a href="' + escapeHtml(bookLink) + '" target="_blank" rel="noopener">&#128279; Link zum Buch</a>';
              html += '</div>';
            }
            html += '</div>';
          }

          // ── Row 3: Footer (date + location + edit) ──
          html += '<div class="cat-book-footer">';
          var months = ['','Jan','Feb','M\u00E4r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
          var locs = book.readLocations || (book.readLocation ? [book.readLocation] : []);
          if (locs.length > 0) {
            html += '<div class="cat-book-location"><span class="cat-book-location-icon">&#128205;</span>' + locs.map(function(l) { return escapeHtml(l); }).join(', ') + '</div>';
          }
          if (book.readFormat) {
            var fmtIcon = book.readFormat === 'physisch' ? '&#128214;' : '&#128241;';
            var fmtLabel = book.readFormat === 'physisch' ? 'Physisch' : 'Digital';
            html += '<div class="cat-book-format"><span class="cat-book-format-icon" aria-hidden="true">' + fmtIcon + '</span>' + fmtLabel + '</div>';
          }
          if (book.status === 'gelesen' && (book.readMonth || book.readYear)) {
            html += '<div class="cat-book-date">';
            html += (book.readMonth ? months[book.readMonth] + ' ' : '') + (book.readYear || '');
            html += '</div>';
          }
          html += '<div class="cat-book-actions-wrap">';
          html += '<button class="edit-btn" onclick="toggleEditForm(\'' + book.id + '\')">&#9998; Bearbeiten</button>';
          html += '</div>';
          html += '</div>';
          html += '<div class="edit-form" id="edit-' + book.id + '">';
          html += '<div class="edit-form-row">';
          html += '<label for="editTitle-' + book.id + '" class="sr-only">Titel</label>';
          html += '<input class="edit-form-input" id="editTitle-' + book.id + '" placeholder="Titel" value="' + escapeHtml(book.title) + '">';
          html += '<label for="editAuthor-' + book.id + '" class="sr-only">Autor</label>';
          html += '<input class="edit-form-input" id="editAuthor-' + book.id + '" placeholder="Autor" value="' + escapeHtml(book.author) + '">';
          html += '</div>';
          html += '<div class="edit-form-row">';
          html += '<label for="editStatus-' + book.id + '" class="sr-only">Status</label>';
          html += '<select class="status-select" id="editStatus-' + book.id + '">';
          html += '<option value="lese-ich"' + (book.status === 'lese-ich' ? ' selected' : '') + '>Lese ich</option>';
          html += '<option value="merkliste"' + (book.status === 'merkliste' ? ' selected' : '') + '>M\u00F6chte ich lesen</option>';
          html += '<option value="gelesen"' + (book.status === 'gelesen' ? ' selected' : '') + '>Gelesen</option>';
          html += '</select>';
          var selMonth = book.readMonth || 0;
          var selYear = book.readYear || 0;
          var curYear = new Date().getFullYear();
          html += '<label for="editReadMonth-' + book.id + '" class="sr-only">Lesemonat</label>';
          html += '<select class="read-date-select" id="editReadMonth-' + book.id + '">';
          html += '<option value="0">Monat</option>';
          for (var m = 1; m <= 12; m++) {
            html += '<option value="' + m + '"' + (selMonth == m ? ' selected' : '') + '>' + months[m] + '</option>';
          }
          html += '</select>';
          html += '<label for="editReadYear-' + book.id + '" class="sr-only">Lesejahr</label>';
          html += '<select class="read-date-select" id="editReadYear-' + book.id + '">';
          html += '<option value="0">Jahr</option>';
          for (var y = curYear; y >= curYear - 10; y--) {
            html += '<option value="' + y + '"' + (selYear == y ? ' selected' : '') + '>' + y + '</option>';
          }
          html += '</select>';
          html += '</div>';
          var locationPresets = ['Zuhause','Pendeln','Urlaub','Strand','Caf\u00E9','Garten','Reise','Zug'];
          var curLocs = book.readLocations || (book.readLocation ? [book.readLocation] : []);
          var customLocs = curLocs.filter(function(l) { return locationPresets.indexOf(l) < 0; });
          html += '<div class="edit-location-row" id="editLocation-' + book.id + '">';
          locationPresets.forEach(function(loc) {
            var isSel = curLocs.indexOf(loc) >= 0;
            html += '<span class="edit-location-chip' + (isSel ? ' selected' : '') + '" role="checkbox" aria-checked="' + isSel + '" tabindex="0" onclick="toggleLocationChip(this)" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleLocationChip(this)}" data-loc="' + loc + '">' + loc + '</span>';
          });
          html += '<label for="editLocationCustom-' + book.id + '" class="sr-only">Anderer Leseort</label>';
          html += '<input class="edit-location-custom" id="editLocationCustom-' + book.id + '" placeholder="Anderer Ort\u2026" value="' + escapeHtml(customLocs.join(', ')) + '">';
          html += '</div>';
          var curFormat = book.readFormat || '';
          html += '<div class="edit-format-row" id="editFormat-' + book.id + '" role="radiogroup" aria-label="Leseformat">';
          html += '<span class="edit-format-label">Format:</span>';
          html += '<span class="edit-format-chip' + (curFormat === 'physisch' ? ' selected' : '') + '" role="radio" aria-checked="' + (curFormat === 'physisch') + '" tabindex="0" data-format="physisch" onclick="toggleFormatChip(this)" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleFormatChip(this)}"><span class="format-icon" aria-hidden="true">&#128214;</span> Physisch</span>';
          html += '<span class="edit-format-chip' + (curFormat === 'digital' ? ' selected' : '') + '" role="radio" aria-checked="' + (curFormat === 'digital') + '" tabindex="0" data-format="digital" onclick="toggleFormatChip(this)" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleFormatChip(this)}"><span class="format-icon" aria-hidden="true">&#128241;</span> Digital / Kindle</span>';
          html += '</div>';
          html += '<div class="edit-form-row edit-cover-row">';
          html += '<input class="edit-form-input full readonly" id="editCover-' + book.id + '" placeholder="Cover-URL (automatisch)" value="' + escapeHtml(book.coverUrl || '') + '" readonly tabindex="-1">';
          html += '<label class="edit-cover-upload-btn" aria-label="Cover-Bild hochladen">';
          html += '<input type="file" accept="image/jpeg,image/png,image/webp" class="sr-only" onchange="handleCoverUpload(this, \'' + book.id + '\')">';
          html += '&#128247; Bild hochladen</label>';
          html += '</div>';
          html += '<div class="edit-form-row">';
          html += '<label for="editBookLink-' + book.id + '" class="sr-only">Link zum Buch</label>';
          html += '<input class="edit-form-input full" id="editBookLink-' + book.id + '" placeholder="Link zum Buch (z.B. Amazon, Thalia, Goodreads)" value="' + escapeHtml(book.bookLink || book.buyLink || book.infoLink || '') + '">';
          html += '</div>';
          html += '<div class="edit-form-row">';
          html += '<label for="editRecommended-' + book.id + '" class="sr-only">Empfohlen von</label>';
          html += '<input class="edit-form-input" id="editRecommended-' + book.id + '" placeholder="Empfohlen von" value="' + escapeHtml(book.recommendedBy || '') + '">';
          html += '</div>';
          var allGenres = ['Thriller','Krimi','Psychothriller','Nordic Noir','Mystery','Science Fiction','Fantasy','Liebesroman','Sachbuch','Biografie','Historisch','Horror','Humor','Klassiker'];
          var bookGenres = book.genres || [];
          html += '<div class="edit-genre-row" id="editGenres-' + book.id + '">';
          allGenres.forEach(function(g) {
            var isSel = bookGenres.indexOf(g) >= 0;
            html += '<span class="edit-genre-chip' + (isSel ? ' selected' : '') + '" role="checkbox" aria-checked="' + isSel + '" tabindex="0" onclick="toggleGenreChip(this)" onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();toggleGenreChip(this)}" data-genre="' + g + '">' + g + '</span>';
          });
          html += '</div>';
          html += '<div class="edit-form-row">';
          html += '<label for="editQuotes-' + book.id + '" class="sr-only">Lieblingszitate</label>';
          html += '<textarea class="edit-quotes-area" id="editQuotes-' + book.id + '" placeholder="Lieblingszitate (ein Zitat pro Zeile)">' + escapeHtml((book.quotes || []).join('\n')) + '</textarea>';
          html += '</div>';
          html += '<div class="edit-hearts-row">';
          html += '<span class="edit-hearts-label">Bewertung:</span>';
          for (var hh = 1; hh <= 5; hh++) {
            html += '<button class="edit-heart-btn' + (hh <= (book.hearts || 0) ? ' filled' : '') + '" data-book="' + book.id + '" data-val="' + hh + '" onclick="setHearts(this)">&hearts;</button>';
          }
          html += '</div>';
          html += '<div class="edit-form-row">';
          html += '<label for="editFazit-' + book.id + '" class="sr-only">Persönliche Notizen</label>';
          html += '<textarea class="edit-fazit-input" id="editFazit-' + book.id + '" placeholder="Pers\u00F6nliche Notizen zum Buch">' + escapeHtml(book.fazit || '') + '</textarea>';
          html += '</div>';
          html += '<div class="edit-form-actions">';
          html += '<button class="edit-save-btn" onclick="saveEdit(\'' + book.id + '\')">Speichern</button>';
          html += '<button class="remove-btn" onclick="removeBook(\'' + book.id + '\')" title="Entfernen" style="font-size:0.65rem;">Entfernen</button>';
          html += '<button class="edit-cancel-btn" onclick="toggleEditForm(\'' + book.id + '\')">Abbrechen</button>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
      }

      html += '</div></div>';
    });

    container.innerHTML = html;
  }

  function changeStatus(bookId, newStatus) {
    if (!currentUser) return;
    db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).update({ status: newStatus });
    setTimeout(loadUserBooks, 300);
  }

  function setHearts(btn) {
    var val = parseInt(btn.getAttribute('data-val'));
    var bookId = btn.getAttribute('data-book');
    var row = btn.parentElement;
    row.querySelectorAll('.edit-heart-btn').forEach(function(b) {
      var bv = parseInt(b.getAttribute('data-val'));
      if (bv <= val) b.classList.add('filled');
      else b.classList.remove('filled');
    });
    row.setAttribute('data-selected', val);
  }

  function handleCoverUpload(input, bookId) {
    var file = input.files && input.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) {
      alert('Bild zu gro\u00DF (max. 5 MB)');
      return;
    }
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        // Resize to max 300px height, maintain aspect ratio
        var maxH = 300;
        var maxW = 200;
        var w = img.width;
        var h = img.height;
        if (h > maxH) { w = w * (maxH / h); h = maxH; }
        if (w > maxW) { h = h * (maxW / w); w = maxW; }
        var canvas = document.createElement('canvas');
        canvas.width = Math.round(w);
        canvas.height = Math.round(h);
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        var dataUrl = canvas.toDataURL('image/jpeg', 0.85);
        // Update the cover URL field
        var coverInput = document.getElementById('editCover-' + bookId);
        if (coverInput) coverInput.value = dataUrl;
        // Show preview: update the cover image in the book card
        var coverImgs = document.querySelectorAll('[data-book-edit-id="' + bookId + '"] img, #edit-' + bookId + ' img');
        // Also find the book card's cover
        var bookCards = document.querySelectorAll('.cat-book-cover img');
        // Visual feedback
        var btn = input.parentElement;
        var origText = btn.innerHTML;
        btn.innerHTML = '&#10003; Hochgeladen';
        setTimeout(function() { btn.innerHTML = origText; }, 2000);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function toggleEditForm(bookId) {
    var form = document.getElementById('edit-' + bookId);
    if (form) form.classList.toggle('active');
  }

  function toggleGenreChip(el) {
    el.classList.toggle('selected');
    el.setAttribute('aria-checked', el.classList.contains('selected') ? 'true' : 'false');
  }

  function toggleLocationChip(el) {
    el.classList.toggle('selected');
    el.setAttribute('aria-checked', el.classList.contains('selected') ? 'true' : 'false');
  }

  function toggleFormatChip(el) {
    var row = el.parentElement;
    var wasSelected = el.classList.contains('selected');
    // Radio-Verhalten: Nur einer aktiv
    row.querySelectorAll('.edit-format-chip').forEach(function(c) {
      c.classList.remove('selected');
      c.setAttribute('aria-checked', 'false');
    });
    if (!wasSelected) {
      el.classList.add('selected');
      el.setAttribute('aria-checked', 'true');
    }
  }

  function saveEdit(bookId) {
    if (!currentUser) return;
    var title = document.getElementById('editTitle-' + bookId).value.trim();
    var author = document.getElementById('editAuthor-' + bookId).value.trim();
    var coverUrl = document.getElementById('editCover-' + bookId).value.trim();
    var bookLink = document.getElementById('editBookLink-' + bookId).value.trim();
    var status = document.getElementById('editStatus-' + bookId).value;
    var readMonth = parseInt(document.getElementById('editReadMonth-' + bookId).value) || 0;
    var readYear = parseInt(document.getElementById('editReadYear-' + bookId).value) || 0;
    if (!title) return;

    var heartsRow = document.querySelector('#edit-' + bookId + ' .edit-hearts-row');
    var hearts = parseInt(heartsRow ? heartsRow.getAttribute('data-selected') : '0') || 0;
    // Fallback: count filled hearts
    if (!hearts && heartsRow) {
      hearts = heartsRow.querySelectorAll('.edit-heart-btn.filled').length;
    }
    var fazit = document.getElementById('editFazit-' + bookId).value.trim();

    var recommendedBy = document.getElementById('editRecommended-' + bookId).value.trim();

    var genres = [];
    var genreChips = document.querySelectorAll('#editGenres-' + bookId + ' .edit-genre-chip.selected');
    genreChips.forEach(function(chip) { genres.push(chip.getAttribute('data-genre')); });

    var quotesRaw = document.getElementById('editQuotes-' + bookId).value.trim();
    var quotes = quotesRaw ? quotesRaw.split('\n').map(function(q) { return q.trim(); }).filter(function(q) { return q.length > 0; }) : [];

    var readLocations = [];
    document.querySelectorAll('#editLocation-' + bookId + ' .edit-location-chip.selected').forEach(function(c) {
      readLocations.push(c.getAttribute('data-loc'));
    });
    var customLoc = document.getElementById('editLocationCustom-' + bookId).value.trim();
    if (customLoc) readLocations.push(customLoc);

    var readFormat = '';
    var selectedFormat = document.querySelector('#editFormat-' + bookId + ' .edit-format-chip.selected');
    if (selectedFormat) readFormat = selectedFormat.getAttribute('data-format');

    var baseUpdate = {
      title: title, author: author || 'Unbekannt', coverUrl: coverUrl,
      bookLink: bookLink, status: status,
      readMonth: readMonth, readYear: readYear,
      hearts: hearts, fazit: fazit,
      recommendedBy: recommendedBy, genres: genres, quotes: quotes,
      readLocations: readLocations,
      readFormat: readFormat
    };

    db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).update(baseUpdate).then(function() {
      announceToSR(title + ' wurde gespeichert.');
      loadUserBooks();
    });
  }

  function setGelesenSort(val) {
    window._gelesenSort = val;
    loadUserBooks();
  }

  function setGelesenYear(val) {
    window._gelesenYear = val === 'all' ? 'all' : parseInt(val);
    loadUserBooks();
  }

  function updateReadDate(bookId, field, value) {
    if (!currentUser) return;
    var update = {};
    update[field === 'month' ? 'readMonth' : 'readYear'] = parseInt(value);
    db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).update(update);
  }

  function removeBook(bookId) {
    if (!currentUser) return;
    db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).delete();
    announceToSR('Buch wurde entfernt.');
    setTimeout(loadUserBooks, 300);
  }

  // ─── Manual Book Entry ───
  function toggleManualForm() {
    var form = document.getElementById('manualForm');
    form.classList.toggle('active');
    if (form.classList.contains('active')) {
      document.getElementById('manualTitle').focus();
    }
  }

  function saveManualBook() {
    if (!currentUser) return;
    var title = document.getElementById('manualTitle').value.trim();
    var author = document.getElementById('manualAuthor').value.trim();
    var status = document.getElementById('manualStatus').value;
    if (!title) { document.getElementById('manualTitle').focus(); return; }

    var slug = slugify(title + '-' + (author || 'unbekannt'));
    var bookData = {
      title: title,
      author: author || 'Unbekannt',
      coverUrl: '',
      rating: 0,
      status: status,
      addedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection('users').doc(currentUser.uid).collection('books').doc(slug).set(bookData).then(function() {
      document.getElementById('manualTitle').value = '';
      document.getElementById('manualAuthor').value = '';
      document.getElementById('manualStatus').value = 'merkliste';
      document.getElementById('manualForm').classList.remove('active');
      loadUserBooks();
    });
  }

  // ─── Book Search (Google Books API) ───
  function grumbeerRain() {
    var count = 60;
    for (var i = 0; i < count; i++) {
      (function(idx) {
        setTimeout(function() {
          var el = document.createElement('div');
          el.textContent = '🥔';
          el.style.cssText = 'position:fixed;top:-50px;font-size:' + (24 + Math.random() * 28) + 'px;z-index:9999;pointer-events:none;left:' + (Math.random() * 100) + 'vw;animation:grumbeer-fall ' + (2 + Math.random() * 3) + 's linear forwards;';
          document.body.appendChild(el);
          setTimeout(function() { el.remove(); }, 5500);
        }, idx * 80);
      })(i);
    }
  }

  // Inject grumbeer animation
  (function() {
    var s = document.createElement('style');
    s.textContent = '@keyframes grumbeer-fall { 0% { transform: translateY(0) rotate(0deg); opacity:1; } 80% { opacity:1; } 100% { transform: translateY(110vh) rotate(' + '720deg); opacity:0; } }';
    document.head.appendChild(s);
  })();

  function searchBooks() {
    var input = document.getElementById('dashSearchInput');
    var btn = document.getElementById('dashSearchBtn');
    var query = input.value.trim();
    if (!query) return;

    if (query.toLowerCase() === 'grumbeer') {
      grumbeerRain();
      input.value = '';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Suche...';

    performSearch(query, btn);
  }

  function fetchGoogleBooks(q, restrictDe) {
    var url = 'https://www.googleapis.com/books/v1/volumes?q=' + encodeURIComponent(q) + '&maxResults=10&printType=books';
    if (restrictDe !== false) url += '&langRestrict=de';
    return fetch(url).then(function(r) { return r.json(); }).then(function(data) {
      return (data.items || []).map(function(item) {
        var info = item.volumeInfo || {};
        var cover = '';
        if (info.imageLinks) {
          cover = (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail || '').replace('http://', 'https://');
        }
        if (!cover) cover = 'https://books.google.com/books/content?id=' + (item.id || '') + '&printsec=frontcover&img=1&zoom=1';
        return {
          title: info.title || 'Unbekannt',
          author: (info.authors || ['Unbekannt']).join(', '),
          year: (info.publishedDate || '').substring(0, 4),
          coverUrl: cover,
          description: info.description || '',
          lang: (info.language || '').toLowerCase(),
          categories: info.categories || [],
          source: 'Google'
        };
      });
    }).catch(function() { return []; });
  }

  function fetchOpenLibrary(q) {
    var url = 'https://openlibrary.org/search.json?q=' + encodeURIComponent(q) + '&limit=10&language=ger';
    return fetch(url).then(function(r) { return r.json(); }).then(function(data) {
      return (data.docs || []).map(function(doc) {
        var coverId = doc.cover_i;
        var cover = coverId ? ('https://covers.openlibrary.org/b/id/' + coverId + '-M.jpg') : '';
        var langs = doc.language || [];
        var hasGer = langs.indexOf('ger') >= 0 || langs.indexOf('de') >= 0;
        return {
          title: doc.title || 'Unbekannt',
          author: (doc.author_name || ['Unbekannt']).join(', '),
          year: doc.first_publish_year ? String(doc.first_publish_year) : '',
          coverUrl: cover,
          description: '',
          lang: hasGer ? 'de' : (langs[0] || ''),
          categories: (doc.subject || []).slice(0, 10),
          source: 'Open Library'
        };
      });
    }).catch(function() { return []; });
  }

  function mapCategoriesToGenres(categories) {
    var map = {
      'Thriller': ['thriller','suspense','spionage','spy','espionage','action & adventure'],
      'Krimi': ['crime','krimi','detective','true crime','criminal','murder','whodunit','police','mystery & detective'],
      'Psychothriller': ['psychological','psychothriller','psychological thriller','psychological fiction'],
      'Nordic Noir': ['nordic noir','scandinavian','skandinavischer krimi'],
      'Mystery': ['mystery','mysteries','cozy mystery','mystery fiction'],
      'Science Fiction': ['science fiction','sci-fi','scifi','dystopia','dystopian','cyberpunk','space','speculative'],
      'Fantasy': ['fantasy','urban fantasy','epic fantasy','dark fantasy','magic','dragons','paranormal'],
      'Liebesroman': ['romance','love','liebesroman','romantic','love stories','chick lit','women\'s fiction','contemporary women','contemporary romance','new adult','roman','fiction / romance','fiction / contemporary','friendship','beziehung','liebe','summer','sommer','beach','lake','cottage','small town','reunions','second chance'],
      'Sachbuch': ['nonfiction','non-fiction','sachbuch','self-help','business','psychology','philosophy','science','education','politics','economics','health','fitness','cooking','travel','nature','true accounts','ratgeber'],
      'Biografie': ['biography','autobiography','biografie','memoir','memoirs','personal memoirs','personal narratives'],
      'Historisch': ['historical','history','historisch','historical fiction','medieval','world war','ancient','century','war','military'],
      'Horror': ['horror','ghost','supernatural','gothic','vampires','zombies','occult'],
      'Humor': ['humor','comedy','humour','satire','funny','comic','witzig'],
      'Klassiker': ['classic','classics','klassiker','literary fiction','literature','literary']
    };
    var joined = categories.map(function(c) { return c.toLowerCase(); }).join(' | ');
    var matched = [];
    Object.keys(map).forEach(function(genre) {
      map[genre].forEach(function(keyword) {
        if (matched.indexOf(genre) < 0 && joined.indexOf(keyword) >= 0) {
          matched.push(genre);
        }
      });
    });
    // Wenn nur "Fiction" als Kategorie da ist und sonst nichts erkannt, Liebesroman als Fallback prüfen
    if (matched.length === 0 && joined.indexOf('fiction') >= 0) {
      matched.push('Klassiker');
    }
    return matched;
  }

  function sortGermanFirst(books) {
    return books.sort(function(a, b) {
      var aDE = (a.lang === 'de') ? 0 : 1;
      var bDE = (b.lang === 'de') ? 0 : 1;
      return aDE - bDE;
    });
  }

  function deduplicateBooks(all) {
    var seen = {};
    var unique = [];
    all.forEach(function(book) {
      var key = slugify(book.title);
      if (!seen[key]) {
        seen[key] = true;
        unique.push(book);
      } else {
        // Kategorien von Duplikaten zusammenführen
        var existing = unique.find(function(b) { return slugify(b.title) === key; });
        if (existing && book.categories && book.categories.length > 0) {
          var cats = existing.categories || [];
          book.categories.forEach(function(c) {
            if (cats.indexOf(c) < 0) cats.push(c);
          });
          existing.categories = cats;
        }
      }
    });
    return unique;
  }

  function performSearch(query, btn) {
    // Phase 1: Deutsche Ergebnisse bevorzugt
    Promise.all([fetchGoogleBooks(query), fetchOpenLibrary(query)]).then(function(results) {
      var unique = deduplicateBooks(results[0].concat(results[1]));
      var deResults = unique.filter(function(b) { return b.lang === 'de'; });

      // Phase 2: Wenn zu wenig deutsche Ergebnisse, auch ohne Sprachfilter suchen
      if (deResults.length < 3) {
        return fetchGoogleBooks(query, false).then(function(allResults) {
          var extra = deduplicateBooks(allResults);
          var allKeys = {};
          unique.forEach(function(b) { allKeys[slugify(b.title)] = true; });
          extra.forEach(function(b) {
            var k = slugify(b.title);
            if (!allKeys[k]) { allKeys[k] = true; unique.push(b); }
          });
          return sortGermanFirst(unique);
        });
      }
      return sortGermanFirst(unique);
    }).then(function(unique) {
      // Phase 3: Wenn wenige Ergebnisse, vereinfachte Suche
      var words = query.split(/\s+/);
      if (unique.length < 3 && words.length > 2) {
        var shortQuery = words.slice(0, Math.min(3, words.length - 1)).join(' ');
        return Promise.all([fetchGoogleBooks(shortQuery), fetchOpenLibrary(shortQuery)]).then(function(r2) {
          var extra = deduplicateBooks(r2[0].concat(r2[1]));
          var allKeys = {};
          unique.forEach(function(b) { allKeys[slugify(b.title)] = true; });
          extra.forEach(function(b) {
            var k = slugify(b.title);
            if (!allKeys[k]) { allKeys[k] = true; unique.push(b); }
          });
          return sortGermanFirst(unique);
        });
      }
      return unique;
    }).then(function(unique) {
      btn.disabled = false;
      btn.textContent = 'Suchen';
      renderSearchResults(unique);
    });
  }

  function renderSearchResults(items) {
    var container = document.getElementById('dashSearchResults');
    container.classList.add('active');

    if (items.length === 0) {
      container.innerHTML = '<div class="search-no-results">Keine Ergebnisse gefunden.</div><div class="search-manual-hint">Buch nicht dabei? <button onclick="closeSearch();toggleManualForm()">Manuell hinzuf\u00FCgen</button></div>';
      return;
    }

    var html = '<div class="search-results-label">Ergebnisse (' + items.length + ') &mdash; <span lang="en">Google Books + Open Library</span></div>';
    html += '<button class="search-close" onclick="closeSearch()">Ergebnisse schlie\u00DFen</button>';

    items.forEach(function(book) {
      var bookSlug = slugify(book.title);
      var escapedTitle = escapeHtml(book.title);
      var escapedAuthor = escapeHtml(book.author);
      var escapedDesc = escapeHtml(book.description || '');
      var autoGenres = mapCategoriesToGenres(book.categories || []);
      var dataAttr = 'data-title="' + escapedTitle + '" data-author="' + escapedAuthor + '" data-cover="' + escapeHtml(book.coverUrl) + '" data-slug="' + escapeHtml(bookSlug) + '" data-desc="' + escapedDesc + '" data-genres="' + escapeHtml(JSON.stringify(autoGenres)) + '"';

      html += '<div class="search-result-item">';
      html += '<div class="search-result-cover"><img src="' + book.coverUrl + '" alt="Cover: ' + escapedTitle + '" data-title="' + escapedTitle + '" onload="checkCoverOnLoad(this)" onerror="handleCoverError(this,this.dataset.title)"></div>';
      html += '<div class="search-result-info">';
      html += '<div class="search-result-title">' + escapedTitle + '</div>';
      html += '<div class="search-result-author">' + escapedAuthor + '</div>';
      if (book.year) html += '<div class="search-result-year">' + book.year + ' &middot; ' + book.source + '</div>';
      else html += '<div class="search-result-year">' + book.source + '</div>';
      if (autoGenres.length > 0) {
        html += '<div class="search-result-genres">';
        autoGenres.forEach(function(g) { html += '<span class="search-genre-pill">' + escapeHtml(g) + '</span>'; });
        html += '</div>';
      }
      html += '</div>';
      html += '<div class="search-result-actions">';
      html += '<button class="search-add-btn" ' + dataAttr + ' onclick="addSearchedBook(this,\'merkliste\')" title="M\u00F6chte ich lesen">&#9203;</button>';
      html += '<button class="search-add-btn" ' + dataAttr + ' onclick="addSearchedBook(this,\'lese-ich\')" title="Lese ich">&#128214;</button>';
      html += '<button class="search-add-btn" ' + dataAttr + ' onclick="addSearchedBook(this,\'gelesen\')" title="Gelesen">&#9733;</button>';
      html += '</div>';
      html += '</div>';
    });

    html += '<div class="search-manual-hint">Nicht das Richtige dabei? <button onclick="closeSearch();toggleManualForm()">Manuell hinzuf\u00FCgen</button></div>';
    html += '<button class="search-close" onclick="closeSearch()">Ergebnisse schlie\u00DFen</button>';
    container.innerHTML = html;
  }

  function addSearchedBook(btn, status) {
    if (!currentUser) return;
    var autoGenres = [];
    try { autoGenres = JSON.parse(btn.getAttribute('data-genres') || '[]'); } catch(e) {}
    var bookData = {
      title: btn.getAttribute('data-title'),
      author: btn.getAttribute('data-author'),
      coverUrl: btn.getAttribute('data-cover'),
      description: btn.getAttribute('data-desc') || '',
      genres: autoGenres,
      rating: 0,
      status: status,
      addedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    var slug = btn.getAttribute('data-slug');

    db.collection('users').doc(currentUser.uid).collection('books').doc(slug).set(bookData).then(function() {
      var row = btn.closest('.search-result-item');
      var allBtns = row.querySelectorAll('.search-add-btn');
      allBtns.forEach(function(b) { b.classList.remove('added'); });
      btn.classList.add('added');
      row.style.opacity = '0.5';
      var statusLabels = {'merkliste':'Merkliste','lese-ich':'Lese ich','gelesen':'Gelesen'};
      announceToSR(bookData.title + ' wurde zu ' + (statusLabels[status] || status) + ' hinzugefügt.');
      loadUserBooks();
    });
  }

  // ─── Suggestions Overlay ───
  function showSuggestionsOverlay() {
    var cards = document.querySelectorAll('.grid .book-card');
    var grid = document.getElementById('suggestionsOverlayGrid');
    var html = '';
    cards.forEach(function(card) {
      var clone = card.cloneNode(true);
      clone.querySelectorAll('.track-btn-row').forEach(function(r) { r.remove(); });
      html += '<div class="book-card" style="border:1px solid var(--card-border);border-radius:var(--radius);padding:20px;background:var(--card);">' + clone.innerHTML + '</div>';
    });
    grid.innerHTML = html;
    document.getElementById('suggestionsOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeSuggestionsOverlay() {
    document.getElementById('suggestionsOverlay').classList.remove('active');
    document.body.style.overflow = '';
  }

  function showBookDetail(bookId) {
    if (!currentUser) return;
    var content = document.getElementById('bookDetailContent');
    content.innerHTML = '<div class="book-detail-loading">Lade Buchdetails\u2026</div>';
    document.getElementById('bookDetailOverlay').classList.add('active');

    db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).get().then(function(doc) {
      if (!doc.exists) { content.innerHTML = '<div class="book-detail-none">Buch nicht gefunden.</div>'; return; }
      var book = doc.data();
      var html = '<div class="book-detail-header">';
      html += '<div class="book-detail-cover"><img src="' + (book.coverUrl || '') + '" alt="Cover: ' + escapeHtml(book.title) + '" data-title="' + escapeHtml(book.title) + '" onload="checkCoverOnLoad(this)" onerror="handleCoverError(this,this.dataset.title)"></div>';
      html += '<div>';
      html += '<div class="book-detail-title">' + escapeHtml(book.title) + '</div>';
      html += '<div class="book-detail-author">' + escapeHtml(book.author) + '</div>';
      html += '</div></div>';

      if (book.description) {
        html += '<div class="book-detail-desc">' + escapeHtml(book.description) + '</div>';
        content.innerHTML = html;
      } else {
        // Versuche deutsche Beschreibung zu finden
        content.innerHTML = html + '<div class="book-detail-loading">Suche Inhaltsangabe\u2026</div>';
        var q = book.title + ' ' + book.author;
        var googleDe = 'https://www.googleapis.com/books/v1/volumes?q=' + encodeURIComponent(q) + '&maxResults=3&printType=books&langRestrict=de';
        var googleAll = 'https://www.googleapis.com/books/v1/volumes?q=' + encodeURIComponent(q) + '&maxResults=3&printType=books';

        function extractDesc(data) {
          if (!data.items) return '';
          for (var i = 0; i < data.items.length; i++) {
            var d = (data.items[i].volumeInfo || {}).description || '';
            if (d) return d;
          }
          return '';
        }

        function isGerman(text) {
          var deWords = ['und','der','die','das','ein','eine','ist','mit','von','den','dem','sich','auf','nicht','als','auch','noch','nach','wird','bei','aus','wie','aber','kann','nur','wenn'];
          var words = text.toLowerCase().split(/\s+/).slice(0, 40);
          var hits = 0;
          words.forEach(function(w) { if (deWords.indexOf(w) >= 0) hits++; });
          return hits >= 3;
        }

        // Schritt 1: Deutsch-beschr\u00E4nkte Suche
        fetch(googleDe).then(function(r) { return r.json(); }).then(function(data) {
          var desc = extractDesc(data);
          if (desc && isGerman(desc)) return desc;
          // Schritt 2: Fallback ohne Sprachfilter, pr\u00FCfe auf Deutsch
          return fetch(googleAll).then(function(r2) { return r2.json(); }).then(function(data2) {
            // Bevorzuge deutsche Beschreibung
            if (data2.items) {
              for (var i = 0; i < data2.items.length; i++) {
                var d = (data2.items[i].volumeInfo || {}).description || '';
                if (d && isGerman(d)) return d;
              }
            }
            // Notfalls erste verf\u00FCgbare Beschreibung
            return desc || extractDesc(data2);
          });
        }).then(function(desc) {
          if (desc) {
            db.collection('users').doc(currentUser.uid).collection('books').doc(bookId).update({ description: desc });
            content.innerHTML = html + '<div class="book-detail-desc">' + escapeHtml(desc) + '</div>';
          } else {
            content.innerHTML = html + '<div class="book-detail-none">Keine Inhaltsangabe verf\u00FCgbar. Du kannst sie im Bearbeitungsmodus selbst erg\u00E4nzen.</div>';
          }
        }).catch(function() {
          content.innerHTML = html + '<div class="book-detail-none">Inhaltsangabe konnte nicht geladen werden.</div>';
        });
      }
    });
  }

  function closeBookDetail() {
    document.getElementById('bookDetailOverlay').classList.remove('active');
  }

  function closeSearch() {
    var container = document.getElementById('dashSearchResults');
    container.classList.remove('active');
    container.innerHTML = '';
    var input = document.getElementById('dashSearchInput');
    if (input) { input.value = ''; input.focus(); }
  }

  function slugify(str) {
    return str.toLowerCase()
      .replace(/[\u00e4\u00c4]/g, 'ae').replace(/[\u00f6\u00d6]/g, 'oe').replace(/[\u00fc\u00dc]/g, 'ue').replace(/\u00df/g, 'ss')
      .replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '').substring(0, 60);
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function handleCoverError(img, title) {
    if (img.dataset.fallbackTried) { showCoverPlaceholder(img, title); return; }
    img.dataset.fallbackTried = '1';
    tryOpenLibraryCover(img, title);
  }

  function checkCoverOnLoad(img) {
    // Google Books "not available" Platzhalter sind oft winzig (1x1 oder sehr klein)
    if (img.naturalWidth <= 1 || img.naturalHeight <= 1) {
      handleCoverError(img, img.dataset.title || '');
    }
  }

  function tryOpenLibraryCover(img, title) {
    var q = encodeURIComponent(title || '');
    fetch('https://openlibrary.org/search.json?q=' + q + '&limit=3&fields=cover_i,title')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var coverId = null;
        (data.docs || []).forEach(function(doc) {
          if (!coverId && doc.cover_i) coverId = doc.cover_i;
        });
        if (coverId) {
          img.onerror = function() { showCoverPlaceholder(img, title); };
          img.onload = null;
          img.src = 'https://covers.openlibrary.org/b/id/' + coverId + '-M.jpg';
        } else {
          showCoverPlaceholder(img, title);
        }
      })
      .catch(function() { showCoverPlaceholder(img, title); });
  }

  function showCoverPlaceholder(img, title) {
    var initials = (title || '?').split(/\s+/).slice(0, 2).map(function(w) { return w.charAt(0).toUpperCase(); }).join('');
    var placeholder = document.createElement('div');
    placeholder.className = 'cover-placeholder';
    placeholder.setAttribute('aria-hidden', 'true');
    placeholder.textContent = initials;
    if (img.parentElement) img.parentElement.replaceChild(placeholder, img);
  }

  // ─── Barrierefreiheit: Escape-Taste & Fokus-Trap ───

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var loginOverlay = document.getElementById('loginOverlay');
      var bookDetail = document.getElementById('bookDetailOverlay');
      var suggestions = document.getElementById('suggestionsOverlay');
      if (loginOverlay.classList.contains('active')) { closeLoginModal(); }
      else if (bookDetail.classList.contains('active')) { closeBookDetail(); }
      else if (suggestions.classList.contains('active')) { closeSuggestionsOverlay(); }
    }
  });

  function trapFocus(container) {
    var focusable = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable.length === 0) return;
    var first = focusable[0];
    var last = focusable[focusable.length - 1];
    container._focusTrapHandler = function(e) {
      if (e.key !== 'Tab') return;
      if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
      } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    };
    container.addEventListener('keydown', container._focusTrapHandler);
    first.focus();
  }

  function releaseFocus(container) {
    if (container._focusTrapHandler) {
      container.removeEventListener('keydown', container._focusTrapHandler);
      delete container._focusTrapHandler;
    }
  }

  // Erweiterte Modal-Funktionen mit Fokus-Trap
  var _origHandleLogin = handleLogin;
  handleLogin = function() {
    _origHandleLogin();
    setTimeout(function() {
      trapFocus(document.querySelector('.login-modal'));
    }, 100);
  };

  var _origCloseLogin = closeLoginModal;
  closeLoginModal = function() {
    releaseFocus(document.querySelector('.login-modal'));
    _origCloseLogin();
  };

  var _origShowBookDetail = showBookDetail;
  showBookDetail = function(bookId) {
    _origShowBookDetail(bookId);
    setTimeout(function() {
      var inner = document.querySelector('.book-detail-inner');
      if (inner) trapFocus(inner);
    }, 200);
  };

  var _origCloseBookDetail = closeBookDetail;
  closeBookDetail = function() {
    releaseFocus(document.querySelector('.book-detail-inner'));
    _origCloseBookDetail();
  };

  var _origShowSuggestions = showSuggestionsOverlay;
  showSuggestionsOverlay = function() {
    _origShowSuggestions();
    setTimeout(function() {
      trapFocus(document.querySelector('.suggestions-overlay-inner'));
    }, 100);
  };

  var _origCloseSuggestions = closeSuggestionsOverlay;
  closeSuggestionsOverlay = function() {
    releaseFocus(document.querySelector('.suggestions-overlay-inner'));
    _origCloseSuggestions();
  };

  // Manuell-Button aria-expanded toggle
  var _origToggleManual = toggleManualForm;
  toggleManualForm = function() {
    _origToggleManual();
    var btn = document.querySelector('.dash-manual-btn');
    var form = document.getElementById('manualForm');
    if (btn && form) {
      btn.setAttribute('aria-expanded', form.classList.contains('active') ? 'true' : 'false');
    }
  };
</script>
</body>
</html>
